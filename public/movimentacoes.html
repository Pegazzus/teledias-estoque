<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimenta√ß√µes - Sistema de Estoque | Teledias Telecom</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="img/logo.png" alt="Teledias" class="sidebar-logo-img" style="width: 50px; height: auto;">
                    <div class="sidebar-logo-text">
                        <h2>Teledias</h2>
                        <span>Sistema de Estoque</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu Principal</div>
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-link-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="pedidos.html" class="nav-link">
                        <span class="nav-link-icon">üìã</span>
                        Pedidos/Propostas
                    </a>
                    <a href="radios.html" class="nav-link">
                        <img src="img/walkie-talkie.png" alt="R√°dio"
                            style="width:20px;height:20px;margin-right:8px;vertical-align:middle">
                        R√°dios
                    </a>
                    <a href="clientes.html" class="nav-link">
                        <span class="nav-link-icon">üë•</span>
                        Clientes
                    </a>
                    <a href="movimentacoes.html" class="nav-link">
                        <span class="nav-link-icon">üîÑ</span>
                        Movimenta√ß√µes
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Cota√ß√µes</div>
                    <a href="cotacoes.html" class="nav-link">
                        <span class="nav-link-icon">üí∞</span>
                        Cota√ß√µes
                    </a>
                    <a href="fornecedores.html" class="nav-link">
                        <span class="nav-link-icon">üè≠</span>
                        Fornecedores
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Manuten√ß√£o</div>
                    <a href="manutencoes.html" class="nav-link">
                        <span class="nav-link-icon">üîß</span>
                        Manuten√ß√µes
                    </a>
                </div>

                <div class="nav-section admin-only">
                    <div class="nav-section-title">Administra√ß√£o</div>
                    <a href="usuarios.html" class="nav-link">
                        <span class="nav-link-icon">üë§</span>
                        Usu√°rios
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div class="user-details">
                        <div class="user-name">Administrador</div>
                        <div class="user-role">Admin</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" title="Sair">üö™</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Hist√≥rico de Movimenta√ß√µes</h1>
                </div>
            </header>

            <div class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Movimenta√ß√µes</h3>
                    </div>

                    <!-- Filter Bar -->
                    <div
                        style="padding: 16px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <label
                                style="font-size:11px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:0.5px;">Tipo</label>
                            <select id="filterTipo" class="form-control" onchange="loadMovimentacoes()"
                                style="width: 150px; font-size: 13px;">
                                <option value="">Todos os tipos</option>
                                <option value="saida">Sa√≠das</option>
                                <option value="retorno">Retornos</option>
                                <option value="manutencao">Manuten√ß√µes</option>
                                <option value="retorno_manutencao">Ret. Manuten√ß√£o</option>
                            </select>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <label
                                style="font-size:11px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:0.5px;">üîç
                                R√°dio</label>
                            <input type="text" id="filterRadio" class="form-control" placeholder="Buscar..."
                                oninput="debounceLoad()" style="width: 130px; font-size: 13px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <label
                                style="font-size:11px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:0.5px;">üîç
                                N¬∫ S√©rie</label>
                            <input type="text" id="filterSerie" class="form-control" placeholder="Buscar..."
                                oninput="debounceLoad()" style="width: 130px; font-size: 13px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <label
                                style="font-size:11px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:0.5px;">üîç
                                Modelo</label>
                            <input type="text" id="filterModelo" class="form-control" placeholder="Buscar..."
                                oninput="debounceLoad()" style="width: 130px; font-size: 13px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <label
                                style="font-size:11px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:0.5px;">üîç
                                Cliente</label>
                            <input type="text" id="filterCliente" class="form-control" placeholder="Buscar..."
                                oninput="debounceLoad()" style="width: 130px; font-size: 13px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <label
                                style="font-size:11px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:0.5px;">üîç
                                Usu√°rio</label>
                            <input type="text" id="filterUsuario" class="form-control" placeholder="Buscar..."
                                oninput="debounceLoad()" style="width: 130px; font-size: 13px;">
                        </div>
                        <button onclick="clearFilters()" class="btn btn-secondary"
                            style="font-size: 13px; padding: 6px 14px; height:34px;">Limpar</button>
                    </div>

                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>R√°dio</th>
                                        <th>N¬∫ S√©rie</th>
                                        <th>Modelo</th>
                                        <th>Cliente</th>
                                        <th>Usu√°rio</th>
                                        <th>Observa√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="movimentacoesTableBody">
                                    <tr>
                                        <td colspan="8">
                                            <div class="empty-state">
                                                <p>Carregando...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- History Modal Overlay -->
    <div id="historyOverlay"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; opacity:0; transition:opacity 0.3s;"
        onclick="closeHistory()"></div>

    <!-- History Slide Panel -->
    <div id="historyPanel"
        style="display:none; position:fixed; top:0; right:-520px; width:520px; max-width:90vw; height:100vh; background:white; z-index:1001; box-shadow:-4px 0 24px rgba(0,0,0,0.15); transition:right 0.3s ease; overflow-y:auto;">
        <div style="padding: 24px;">
            <!-- Panel Header -->
            <div
                style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid var(--gray-200);">
                <div>
                    <h2 style="margin:0; font-size:18px; color:var(--gray-800);" id="historyTitle">Hist√≥rico do R√°dio
                    </h2>
                    <p style="margin:4px 0 0; font-size:13px; color:var(--gray-500);" id="historySubtitle"></p>
                </div>
                <button onclick="closeHistory()"
                    style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--gray-400); padding:4px 8px; border-radius:6px;"
                    onmouseover="this.style.background='var(--gray-100)'"
                    onmouseout="this.style.background='none'">‚úï</button>
            </div>

            <!-- Radio Info Card -->
            <div id="radioInfoCard"
                style="background:var(--gray-50); border-radius:10px; padding:16px; margin-bottom:24px; border:1px solid var(--gray-200);">
            </div>

            <!-- Timeline -->
            <div id="historyTimeline"></div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        if (!requireAuth()) throw new Error('N√£o autenticado');
        initUserInfo();
        setActiveNav();

        const tipoMap = {
            'saida': { label: 'Sa√≠da', class: 'badge-cliente', icon: 'üì§', color: '#e74c3c' },
            'retorno': { label: 'Retorno', class: 'badge-estoque', icon: 'üì•', color: '#27ae60' },
            'manutencao': { label: 'Manuten√ß√£o', class: 'badge-manutencao', icon: 'üîß', color: '#f39c12' },
            'retorno_manutencao': { label: 'Ret. Manuten√ß√£o', class: 'badge-estoque', icon: '‚úÖ', color: '#27ae60' }
        };

        const statusMap = {
            'estoque': { label: 'Em Estoque', class: 'badge-estoque' },
            'cliente': { label: 'Com Cliente', class: 'badge-cliente' },
            'manutencao': { label: 'Em Manuten√ß√£o', class: 'badge-manutencao' }
        };

        let debounceTimer = null;
        function debounceLoad() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(loadMovimentacoes, 400);
        }

        function clearFilters() {
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterRadio').value = '';
            document.getElementById('filterSerie').value = '';
            document.getElementById('filterModelo').value = '';
            document.getElementById('filterCliente').value = '';
            document.getElementById('filterUsuario').value = '';
            loadMovimentacoes();
        }

        async function loadMovimentacoes() {
            try {
                const params = new URLSearchParams();
                const tipo = document.getElementById('filterTipo').value;
                const radio = document.getElementById('filterRadio').value.trim();
                const serie = document.getElementById('filterSerie').value.trim();
                const modelo = document.getElementById('filterModelo').value.trim();
                const cliente = document.getElementById('filterCliente').value.trim();
                const usuario = document.getElementById('filterUsuario').value.trim();

                if (tipo) params.set('tipo', tipo);
                if (radio) params.set('radio', radio);
                if (serie) params.set('serie', serie);
                if (modelo) params.set('modelo', modelo);
                if (cliente) params.set('cliente', cliente);
                if (usuario) params.set('usuario', usuario);

                const qs = params.toString();
                const url = '/api/movimentacoes' + (qs ? '?' + qs : '');
                const response = await fetchApi(url);
                const movimentacoes = await response.json();

                const tbody = document.getElementById('movimentacoesTableBody');

                if (movimentacoes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üîÑ</div>
                                    <h3>Nenhuma movimenta√ß√£o encontrada</h3>
                                    <p>O hist√≥rico de movimenta√ß√µes aparecer√° aqui.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = movimentacoes.map(mov => {
                    const tipoInfo = tipoMap[mov.tipo] || { label: mov.tipo, class: '' };
                    return `
                        <tr onclick="openHistory(${mov.radio_id})" style="cursor:pointer;" onmouseover="this.style.background='var(--primary-50)'" onmouseout="this.style.background=''">
                            <td>${formatDate(mov.created_at)}</td>
                            <td><span class="badge ${tipoInfo.class}">${tipoInfo.label}</span></td>
                            <td>
                                <strong>${mov.radio_codigo}</strong>
                                ${mov.radio_proprietario_tipo === 'Parceiro' ? '<span class="badge" style="background:#fffaf0; color:#dd6b20; border:1px solid #fbd38d; font-size:0.7rem; margin-left:8px; padding:2px 6px;" title="Equipamento Parceiro">ü§ù Parceiro</span>' : ''}
                            </td>
                            <td style="color: var(--gray-500); font-size: 13px;">${mov.radio_numero_serie || '-'}</td>
                            <td>${mov.radio_modelo}</td>
                            <td>${mov.cliente_nome || '-'}</td>
                            <td>${mov.usuario_nome || '-'}</td>
                            <td>${mov.observacoes || '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                showToast('Erro ao carregar movimenta√ß√µes', 'error');
            }
        }

        async function openHistory(radioId) {
            const overlay = document.getElementById('historyOverlay');
            const panel = document.getElementById('historyPanel');

            // Show and animate in
            overlay.style.display = 'block';
            panel.style.display = 'block';
            setTimeout(() => {
                overlay.style.opacity = '1';
                panel.style.right = '0';
            }, 10);

            // Loading state
            document.getElementById('historyTitle').textContent = 'Carregando...';
            document.getElementById('historySubtitle').textContent = '';
            document.getElementById('radioInfoCard').innerHTML = '<p style="text-align:center;color:var(--gray-400);">‚è≥ Carregando dados...</p>';
            document.getElementById('historyTimeline').innerHTML = '';

            try {
                const response = await fetchApi(`/api/movimentacoes/radio/${radioId}`);
                const data = await response.json();
                const radio = data.radio;
                const movs = data.movimentacoes;

                // Header
                document.getElementById('historyTitle').textContent = `R√°dio ${radio.codigo}`;
                document.getElementById('historySubtitle').textContent = `${radio.modelo || ''} ${radio.marca ? '‚Ä¢ ' + radio.marca : ''}`;

                // Radio info card
                const st = statusMap[radio.status] || { label: radio.status, class: '' };
                document.getElementById('radioInfoCard').innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                        <div>
                            <span style="font-size:11px; color:var(--gray-500); text-transform:uppercase;">Status</span>
                            <div style="margin-top:4px;"><span class="badge ${st.class}">${st.label}</span></div>
                        </div>
                        <div>
                            <span style="font-size:11px; color:var(--gray-500); text-transform:uppercase;">Cliente</span>
                            <div style="margin-top:4px; font-weight:500; color:var(--gray-800);">${radio.cliente_nome || '-'}</div>
                        </div>
                        <div>
                            <span style="font-size:11px; color:var(--gray-500); text-transform:uppercase;">Origem</span>
                            <div style="margin-top:4px;">${radio.proprietario_tipo === 'Parceiro' ? '<span class="badge" style="background:#fffaf0; color:#dd6b20; border:1px solid #fbd38d; font-size:0.7rem; padding:2px 6px;">ü§ù Parceiro</span>' : '<span style="color:var(--gray-500); font-size:13px;">üè¢ Pr√≥prio</span>'}</div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;">
                        <div>
                            <div style="font-size:11px; color:var(--gray-400); text-transform:uppercase; letter-spacing:0.5px;">C√≥digo</div>
                            <div style="font-weight:600; color:var(--gray-800);">${radio.codigo}</div>
                        </div>
                        <div>
                            <div style="font-size:11px; color:var(--gray-400); text-transform:uppercase; letter-spacing:0.5px;">N¬∫ S√©rie</div>
                            <div style="font-weight:600; color:var(--gray-800);">${radio.numero_serie || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size:11px; color:var(--gray-400); text-transform:uppercase; letter-spacing:0.5px;">Modelo</div>
                            <div style="font-weight:600; color:var(--gray-800);">${radio.modelo || '-'}</div>
                        </div>
                        <div>
                        </div>
                        ${radio.cliente_nome ? `
                        <div style="grid-column: span 2;">
                            <div style="font-size:11px; color:var(--gray-400); text-transform:uppercase; letter-spacing:0.5px;">Cliente Atual</div>
                            <div style="font-weight:600; color:var(--gray-800);">${radio.cliente_nome}</div>
                        </div>` : ''}
                    </div>
                `;

                // Build timeline
                let timeline = '';

                // First item: cadastro
                timeline += `
                    <div style="display:flex; gap:16px; position:relative;">
                        <div style="display:flex; flex-direction:column; align-items:center; flex-shrink:0;">
                            <div style="width:32px; height:32px; border-radius:50%; background:var(--primary-100); display:flex; align-items:center; justify-content:center; font-size:16px; border:2px solid var(--primary-400);">üì¶</div>
                            ${movs.length > 0 ? '<div style="width:2px; flex:1; background:var(--gray-200); margin:4px 0;"></div>' : ''}
                        </div>
                        <div style="padding-bottom:24px; flex:1;">
                            <div style="font-weight:600; color:var(--gray-800); font-size:14px;">Cadastro do R√°dio</div>
                            <div style="font-size:12px; color:var(--gray-400); margin-top:2px;">${formatDate(radio.created_at)}</div>
                            <div style="margin-top:6px; padding:8px 12px; background:var(--gray-50); border-radius:8px; font-size:13px; color:var(--gray-600);">
                                R√°dio cadastrado no sistema
                            </div>
                        </div>
                    </div>
                `;

                // Movement items
                movs.forEach((mov, i) => {
                    const info = tipoMap[mov.tipo] || { label: mov.tipo, icon: '‚Ä¢', color: '#888' };
                    const isLast = i === movs.length - 1;

                    timeline += `
                        <div style="display:flex; gap:16px; position:relative;">
                            <div style="display:flex; flex-direction:column; align-items:center; flex-shrink:0;">
                                <div style="width:32px; height:32px; border-radius:50%; background:${info.color}15; display:flex; align-items:center; justify-content:center; font-size:16px; border:2px solid ${info.color};">${info.icon}</div>
                                ${!isLast ? '<div style="width:2px; flex:1; background:var(--gray-200); margin:4px 0;"></div>' : ''}
                            </div>
                            <div style="padding-bottom:${isLast ? '8' : '24'}px; flex:1;">
                                <div style="font-weight:600; color:var(--gray-800); font-size:14px;">${info.label}</div>
                                <div style="font-size:12px; color:var(--gray-400); margin-top:2px;">${formatDate(mov.created_at)}</div>
                                <div style="margin-top:6px; padding:8px 12px; background:var(--gray-50); border-radius:8px; font-size:13px; color:var(--gray-600);">
                                    ${mov.cliente_nome ? `<strong>Cliente:</strong> ${mov.cliente_nome}<br>` : ''}
                                    ${mov.usuario_nome ? `<strong>Usu√°rio:</strong> ${mov.usuario_nome}<br>` : ''}
                                    ${mov.observacoes ? `<strong>Obs:</strong> ${mov.observacoes}` : 'Sem observa√ß√µes'}
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (movs.length === 0) {
                    timeline += `
                        <div style="text-align:center; padding:24px; color:var(--gray-400);">
                            <p>üìã Nenhuma movimenta√ß√£o registrada para este r√°dio.</p>
                        </div>
                    `;
                }

                document.getElementById('historyTimeline').innerHTML = timeline;
            } catch (error) {
                document.getElementById('radioInfoCard').innerHTML = '<p style="text-align:center;color:#e74c3c;">‚ùå Erro ao carregar hist√≥rico</p>';
            }
        }

        function closeHistory() {
            const overlay = document.getElementById('historyOverlay');
            const panel = document.getElementById('historyPanel');
            overlay.style.opacity = '0';
            panel.style.right = '-520px';
            setTimeout(() => {
                overlay.style.display = 'none';
                panel.style.display = 'none';
            }, 300);
        }

        // Close on Escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeHistory();
        });

        // Inicializar
        loadMovimentacoes();
    </script>
</body>

</html>