<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos & Propostas - Sistema de Estoque | Teledias Telecom</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Signature Pad Library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        /* Tabs e Layout do Modal de Pedidos */
        .tabs-header {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary-500);
        }

        .tab-btn.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
        }

        .tab-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checklist-item:hover {
            background: var(--gray-100);
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }

        .equipamentos-grid {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 16px;
        }

        .badge-sla-ok {
            background-color: #e6f4ea;
            color: #137333;
        }

        .badge-sla-warning {
            background-color: #fef7e0;
            color: #b06000;
        }

        .badge-sla-danger {
            background-color: #fce8e6;
            color: #c5221f;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(197, 34, 31, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(197, 34, 31, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(197, 34, 31, 0);
            }
        }

        .timeline-item {
            display: flex;
            gap: 16px;
            position: relative;
            padding-bottom: 24px;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            top: 24px;
            left: 11px;
            bottom: 0;
            width: 2px;
            background: var(--gray-200);
        }

        .timeline-item:last-child::after {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="img/logo.png" alt="Teledias" class="sidebar-logo-img" style="width: 50px; height: auto;">
                    <div class="sidebar-logo-text">
                        <h2>Teledias</h2>
                        <span>Sistema de Estoque</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu Principal</div>
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-link-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="pedidos.html" class="nav-link">
                        <span class="nav-link-icon">üìã</span>
                        Pedidos/Propostas
                    </a>
                    <a href="radios.html" class="nav-link">
                        <img src="img/walkie-talkie.png" alt="R√°dio"
                            style="width:20px;height:20px;margin-right:8px;vertical-align:middle">
                        R√°dios
                    </a>
                    <a href="clientes.html" class="nav-link">
                        <span class="nav-link-icon">üë•</span>
                        Clientes
                    </a>
                    <a href="movimentacoes.html" class="nav-link">
                        <span class="nav-link-icon">üîÑ</span>
                        Movimenta√ß√µes
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Cota√ß√µes</div>
                    <a href="cotacoes.html" class="nav-link">
                        <span class="nav-link-icon">üí∞</span>
                        Cota√ß√µes
                    </a>
                    <a href="fornecedores.html" class="nav-link">
                        <span class="nav-link-icon">üè≠</span>
                        Fornecedores
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Manuten√ß√£o</div>
                    <a href="manutencoes.html" class="nav-link">
                        <span class="nav-link-icon">üîß</span>
                        Manuten√ß√µes
                    </a>
                </div>

                <div class="nav-section admin-only">
                    <div class="nav-section-title">Administra√ß√£o</div>
                    <a href="usuarios.html" class="nav-link">
                        <span class="nav-link-icon">üë§</span>
                        Usu√°rios
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div class="user-details">
                        <div class="user-name">Administrador</div>
                        <div class="user-role">Admin</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" title="Sair">üö™</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Fluxo de Pedidos & Propostas</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openNewPedidoModal()">+ Novo Pedido</button>
                </div>
            </header>

            <div class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pedidos em Andamento</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Fase Atual</th>
                                        <th>SLA / Prazo</th>
                                        <th>Criado Por</th>
                                        <th>Data Cria√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="pedidosTableBody">
                                    <tr>
                                        <td colspan="6">
                                            <div class="empty-state">Carregando...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Novo Pedido Modal -->
    <div id="newPedidoModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div class="modal-content"
            style="background:white; padding:32px; border-radius:12px; width:650px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2);">

            <h3
                style="margin-bottom:24px; color:var(--gray-800); border-bottom:1px solid var(--gray-200); padding-bottom:12px;">
                Nova Proposta / Pedido</h3>

            <div
                style="background:var(--primary-50); padding:16px; border-radius:8px; border:1px solid var(--primary-200); margin-bottom:24px;">
                <h4 style="margin-top:0; margin-bottom:12px; color:var(--primary-700);">Tipo do Pedido</h4>
                <select id="tipoPedidoSelect" class="form-control"
                    style="font-size:16px; padding:10px; font-weight:bold;">
                    <option value="venda">üì¶ Venda (Novo)</option>
                    <option value="venda_seminovos">‚ôªÔ∏è Venda Seminovos</option>
                    <option value="manutencao_radios">üîß Manuten√ß√£o R√°dios</option>
                </select>
            </div>

            <div
                style="background:var(--gray-50); padding:16px; border-radius:8px; border:1px solid var(--gray-200); margin-bottom:24px;">
                <h4 style="margin-top:0; margin-bottom:12px; color:var(--primary-600);">1. Dados do Cliente</h4>

                <div class="tabs-header" style="margin-bottom:16px; border-bottom:1px solid var(--gray-200);">
                    <button class="tab-btn active" id="btn-cliente-existente" onclick="toggleClienteMode('existente')"
                        style="padding:8px 16px;">Cliente Existente</button>
                    <button class="tab-btn" id="btn-cliente-novo" onclick="toggleClienteMode('novo')"
                        style="padding:8px 16px;">Novo Cliente</button>
                </div>

                <div id="modo-cliente-existente">
                    <div class="form-group" style="margin-bottom:0;">
                        <label>Selecionar Cliente</label>
                        <select id="newPedidoCliente" class="form-control"></select>
                    </div>
                </div>

                <div id="modo-cliente-novo" style="display:none;">
                    <div class="form-row" style="align-items:flex-end;">
                        <div class="form-group" style="flex:1;">
                            <label>Buscar por CNPJ</label>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="novoCNPJ" class="form-control" placeholder="Apenas n√∫meros...">
                                <button class="btn btn-outline" type="button" onclick="buscarCNPJ()"
                                    id="btnBuscarCNPJ">Buscar</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Raz√£o Social / Nome</label>
                        <input type="text" id="novoNome" class="form-control"
                            placeholder="Raz√£o Social ou Nome Fantasia">
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Telefone</label>
                            <input type="text" id="novoTelefone" class="form-control" placeholder="(00) 0000-0000">
                        </div>
                        <div class="form-group" style="flex:2;">
                            <label>Endere√ßo Completo</label>
                            <input type="text" id="novoEndereco" class="form-control"
                                placeholder="Rua, N√∫mero, Bairro, Cidade - UF">
                        </div>
                    </div>
                </div>
            </div>

            <div
                style="background:var(--gray-50); padding:16px; border-radius:8px; border:1px solid var(--gray-200); margin-bottom:24px;">
                <h4 style="margin-top:0; margin-bottom:12px; color:var(--primary-600);">2. Solicita√ß√£o de R√°dios
                    (Condi√ß√µes Comerciais)</h4>

                <div class="form-row" style="align-items:flex-end;">
                    <div class="form-group" style="flex:2;">
                        <label>Modelo do R√°dio</label>
                        <input type="text" id="addModeloInput" class="form-control" placeholder="Ex: DEP450">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Quantidade</label>
                        <input type="number" id="addQtdInput" class="form-control" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-outline" onclick="addSolicitacaoRow()"
                            style="white-space:nowrap;">+ Adicionar</button>
                    </div>
                </div>

                <div class="table-container" style="margin-top:12px;">
                    <table style="box-shadow:none; margin-bottom:0;">
                        <thead style="background:white;">
                            <tr>
                                <th>Modelo Solicitado</th>
                                <th style="text-align:center; width:80px;">Qtd</th>
                                <th style="text-align:center; width:50px;">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="solicitacoesTbody">
                            <tr>
                                <td colspan="3" style="text-align:center; color:var(--gray-400); padding:12px;">
                                    Nenhum radiocomunicador solicitado.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes Iniciais</label>
                <textarea id="newPedidoObs" class="form-control" rows="2"
                    placeholder="Notas sobre contrato, prazos ou pend√™ncias comerciais..."></textarea>
            </div>

            <div
                style="display:flex; justify-content:flex-end; gap:12px; border-top:1px solid var(--gray-200); padding-top:16px; margin-top:24px;">
                <button class="btn btn-secondary" onclick="closeNewPedidoModal()">Cancelar</button>
                <button class="btn btn-primary" id="btnCriarPedido" onclick="createPedidoComplex()">Gerar
                    Proposta/Pedido</button>
            </div>
        </div>
    </div>

    <!-- Pedido Slide Panel -->
    <div id="pedidoPanelOverlay"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; opacity:0; transition:opacity 0.3s;"
        onclick="closePedidoPanel()"></div>

    <div id="pedidoPanel"
        style="display:none; position:fixed; top:0; right:-800px; width:800px; max-width:95vw; height:100vh; background:white; z-index:1001; box-shadow:-4px 0 24px rgba(0,0,0,0.15); transition:right 0.3s ease; flex-direction:column;">

        <!-- Panel Header -->
        <div style="padding:24px; border-bottom:1px solid var(--gray-200); background:var(--gray-50);">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                        <h2 style="margin:0; font-size:20px; color:var(--gray-800);">Pedido #<span
                                id="panelPedidoId"></span></h2>
                        <span id="panelSlaBadge" class="badge"></span>
                    </div>
                    <div style="color:var(--gray-500); font-size:14px;">Cliente: <strong id="panelCliente"
                            style="color:var(--gray-700);"></strong></div>
                </div>
                <div style="display:flex; align-items:center; gap:16px;">
                    <button class="btn btn-outline btn-sm" onclick="gerarContratoPDF()" id="btnGerarPDF"
                        style="display:flex; align-items:center; gap:6px;">
                        üìÑ Gerar Contrato PDF
                    </button>
                    <button onclick="closePedidoPanel()"
                        style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--gray-400);">‚úï</button>
                </div>
            </div>
        </div>

        <!-- Panel Body (Scrollable) -->
        <div style="padding:24px; flex:1; overflow-y:auto;" id="panelBody">
            <div class="tabs-header" style="flex-wrap:wrap; display:flex; gap:4px;">
                <button class="tab-btn active" onclick="switchTab('tab-comercial')" id="btn-tab-comercial">1.
                    Comercial</button>
                <button class="tab-btn" onclick="switchTab('tab-logistica')" id="btn-tab-logistica">2.
                    Log√≠stica</button>
                <button class="tab-btn" onclick="switchTab('tab-laboratorio')" id="btn-tab-laboratorio">3.
                    Laborat√≥rio</button>
                <button class="tab-btn" onclick="switchTab('tab-consultor')" id="btn-tab-consultor">4. Consultor
                    Ext.</button>
                <button class="tab-btn" onclick="switchTab('tab-financeiro')" id="btn-tab-financeiro">5.
                    Financeiro</button>
                <button class="tab-btn" onclick="switchTab('tab-qualidade')" id="btn-tab-qualidade">6. CQ</button>
                <button class="tab-btn" onclick="switchTab('tab-auditoria')" id="btn-tab-auditoria"
                    style="margin-left:auto;">Hist√≥rico/Audit</button>
            </div>

            <!-- Tab Content: Comercial -->
            <div id="tab-comercial" class="tab-content active">
                <h4 style="margin-bottom:16px; color:var(--gray-700);">Checklist do Comercial</h4>
                <div id="checklists-comercial"></div>
                <div class="read-only-equips-container" style="margin-top:32px;"></div>
            </div>

            <!-- Tab Content: Log√≠stica -->
            <div id="tab-logistica" class="tab-content">
                <h4 style="margin-bottom:16px; color:var(--gray-700);">Checklist da Log√≠stica</h4>
                <div id="checklists-logistica"></div>

                <div style="margin-top:32px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div>
                        <h4 style="margin:0; color:var(--gray-700);">Equipamentos Vinculados (Separa√ß√£o)</h4>
                        <p style="margin:4px 0 0 0; font-size:12px; color:var(--gray-500);">Utilize um leitor USB ou
                            a c√¢mera para adicionar itens.</p>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-outline btn-sm" onclick="abrirCameraScanner()">üì∑ Escanear
                            C√¢mera</button>
                        <button class="btn btn-secondary btn-sm" id="btnEditEquips" onclick="addEquipRow()">+
                            Manual</button>
                    </div>
                </div>

                <div id="scannerAlerts" style="margin-top:12px;"></div>

                <div class="equipamentos-grid" style="margin-top:12px;">
                    <table style="margin:0; box-shadow:none;">
                        <thead style="background:var(--gray-50);">
                            <tr>
                                <th>N¬∫ S√©rie</th>
                                <th>Modelo</th>
                                <th>Acess√≥rios</th>
                                <th style="width:50px;">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="equipLogisticaBody"></tbody>
                    </table>
                </div>
                <div style="margin-top:10px; text-align:right;">
                    <button class="btn btn-primary btn-sm" id="btnSaveEquips" onclick="saveEquipamentos()"
                        style="display:none;">Salvar Equipamentos</button>
                </div>

                <!-- Cota√ß√£o de Frete (Log√≠stica para o Financeiro) -->
                <div style="margin-top:32px; padding-top:24px; border-top:1px solid var(--gray-200);">
                    <h4 style="margin-top:0; margin-bottom:12px; color:var(--gray-700);">Cota√ß√£o de Transportadora
                    </h4>
                    <div class="form-row">
                        <div class="form-group" style="flex:2;">
                            <label>Transportadora</label>
                            <input type="text" id="logTransportadora" class="form-control"
                                placeholder="Nome da Transportadora" oninput="showBtnSalvarFrete()">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Valor do Frete (R$)</label>
                            <input type="number" id="logFreteValor" class="form-control" step="0.01" placeholder="0.00"
                                oninput="showBtnSalvarFrete()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Peso (kg)</label>
                            <input type="number" id="logFretePeso" class="form-control" step="0.1" placeholder="ex: 5.5"
                                oninput="showBtnSalvarFrete()">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Dimens√µes (CxLxA) cm</label>
                            <input type="text" id="logFreteDimensoes" class="form-control" placeholder="Ex: 30x20x15"
                                oninput="showBtnSalvarFrete()">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                        <div id="freteStatusBadge" style="font-size:13px; font-weight:bold;"></div>
                        <button id="btnSalvarFrete" class="btn btn-primary btn-sm" style="display:none;"
                            onclick="salvarCotacaoFrete()">Salvar Cota√ß√£o de Frete</button>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Laborat√≥rio -->
            <div id="tab-laboratorio" class="tab-content">
                <h4 style="margin-bottom:16px; color:var(--gray-700);">Checklist do Laborat√≥rio</h4>
                <div id="checklists-laboratorio"></div>

                <div style="margin-top:32px; border-top:1px solid var(--gray-200); padding-top:24px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h4 style="margin:0; color:var(--gray-700);">Pe√ßas e Servi√ßos Aplicados</h4>
                    </div>

                    <div id="planoSafeAlert"
                        style="display:none; background-color:#e6fffa; color:#234e52; border:1px solid #81e6d9; padding:12px 16px; border-radius:8px; margin-bottom:16px; font-weight:600; font-size:14px; align-items:center; gap:8px;">
                        üõ°Ô∏è CLIENTE POSSUI PLANO SAFE - COBRAN√áA DE PE√áAS E M.O. ISENTA
                    </div>

                    <div id="addPecaForm"
                        style="display:none; background:var(--gray-50); padding:16px; border-radius:8px; border:1px solid var(--gray-200); margin-bottom:16px;">
                        <div class="form-row" style="align-items:flex-end;">
                            <div class="form-group" style="flex:2;">
                                <label class="form-label">Pe√ßa (Pre√ßo Indenizat√≥rio)</label>
                                <select id="novoPecaSelect" class="form-control">
                                    <option value="">Carregando pe√ßas...</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label class="form-label">Qtd</label>
                                <input type="number" id="novoPecaQtd" class="form-control" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="addPecaAoPedido()">Adicionar Pe√ßa</button>
                            </div>
                        </div>
                    </div>

                    <div class="equipamentos-grid">
                        <table style="margin:0; box-shadow:none;">
                            <thead style="background:var(--gray-50);">
                                <tr>
                                    <th>A√ß√£o</th>
                                    <th>Pe√ßa/Componente</th>
                                    <th>Mod. Equip.</th>
                                    <th>Valor Un.</th>
                                    <th>M.O.</th>
                                    <th>Qtd</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="pecasTbody"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:16px; text-align:right; font-size:18px; color:var(--gray-800);">
                        Total Pe√ßas/Servi√ßos: <strong id="totalPecasValor">R$ 0,00</strong>
                    </div>
                </div>

                <!-- Gest√£o de Frequ√™ncias -->
                <div style="margin-top:32px; border-top:1px solid var(--gray-200); padding-top:24px;">
                    <h4 style="margin:0 0 16px 0; color:var(--gray-700);">Frequ√™ncias do Cliente</h4>
                    <div id="addFrequenciaForm"
                        style="background:var(--gray-50); padding:16px; border-radius:8px; border:1px solid var(--gray-200); margin-bottom:16px;">
                        <div class="form-row" style="margin-bottom:8px;">
                            <div class="form-group"><label>TX</label><input type="text" id="freqTx" class="form-control"
                                    placeholder="Ex: 460.1250"></div>
                            <div class="form-group"><label>RX</label><input type="text" id="freqRx" class="form-control"
                                    placeholder="Ex: 460.1250"></div>
                            <div class="form-group"><label>Subtom TX</label><input type="text" id="freqSubTx"
                                    class="form-control" placeholder="Ex: 67.0"></div>
                            <div class="form-group"><label>Subtom RX</label><input type="text" id="freqSubRx"
                                    class="form-control" placeholder="Ex: 67.0"></div>
                        </div>
                        <div class="form-row" style="align-items:flex-end;">
                            <div class="form-group" style="flex:1;"><label>Canal</label><input type="text"
                                    id="freqCanal" class="form-control" placeholder="Ex: 1"></div>
                            <div class="form-group" style="flex:3;"><label>Observa√ß√µes</label><input type="text"
                                    id="freqObs" class="form-control" placeholder="..."></div>
                            <div class="form-group"><button class="btn btn-primary" onclick="addFrequencia()">+ Add
                                    Frequ√™ncia</button></div>
                        </div>
                    </div>
                    <div class="equipamentos-grid">
                        <table style="margin:0; box-shadow:none;">
                            <thead style="background:var(--gray-50);">
                                <tr>
                                    <th>Canal</th>
                                    <th>TX</th>
                                    <th>RX</th>
                                    <th>Sub TX</th>
                                    <th>Sub RX</th>
                                    <th>Obs</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="frequenciasTbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Gest√£o de Chips POC -->
                <div style="margin-top:32px; border-top:1px solid var(--gray-200); padding-top:24px;">
                    <h4 style="margin:0 0 16px 0; color:var(--gray-700);">Chips POC (M2M)</h4>
                    <div id="addChipForm"
                        style="background:var(--gray-50); padding:16px; border-radius:8px; border:1px solid var(--gray-200); margin-bottom:16px;">
                        <div class="form-row" style="align-items:flex-end;">
                            <div class="form-group" style="flex:2;"><label>ICCID</label><input type="text"
                                    id="chipIccid" class="form-control" placeholder="8955..."></div>
                            <div class="form-group" style="flex:1;"><label>Linha</label><input type="text"
                                    id="chipLinha" class="form-control" placeholder="(11) 9..."></div>
                            <div class="form-group" style="flex:1;"><label>Operadora</label><input type="text"
                                    id="chipOperadora" class="form-control" placeholder="Vivo/Claro..."></div>
                            <div class="form-group" style="flex:1;"><label>Plano</label><input type="text"
                                    id="chipPlano" class="form-control" placeholder="500MB..."></div>
                            <div class="form-group"><button class="btn btn-primary" onclick="addChip()">+ Add
                                    Chip</button></div>
                        </div>
                    </div>
                    <div class="equipamentos-grid">
                        <table style="margin:0; box-shadow:none;">
                            <thead style="background:var(--gray-50);">
                                <tr>
                                    <th>ICCID</th>
                                    <th>Linha</th>
                                    <th>Operadora</th>
                                    <th>Plano</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="chipsTbody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="read-only-equips-container" style="margin-top:32px;"></div>
            </div>

            <!-- Tab Content: Financeiro -->
            <div id="tab-financeiro" class="tab-content">
                <h4 style="margin-bottom:16px; color:var(--gray-700);">Checklist Financeiro</h4>
                <div id="checklists-financeiro"></div>

                <!-- Aprova√ß√£o de Frete -->
                <div id="financeiroFreteContainer"
                    style="display:none; margin-top:32px; padding:20px; border-radius:8px; border:1px solid var(--gray-200); background:var(--gray-50);">
                    <div
                        style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
                        <div>
                            <h4 style="margin:0 0 8px 0; color:var(--gray-800);">Aprova√ß√£o de Frete (Via Log√≠stica)
                            </h4>
                            <div id="finFreteDetalhes" style="font-size:14px; color:var(--gray-600); line-height:1.5;">
                            </div>
                        </div>
                        <div id="finFreteStatusBadge"
                            style="font-size:14px; font-weight:bold; padding:4px 8px; border-radius:4px;"></div>
                    </div>

                    <div id="finFreteAcoes"
                        style="display:flex; gap:12px; border-top:1px solid var(--gray-200); padding-top:16px;">
                        <button class="btn btn-outline" style="color:var(--danger); border-color:var(--danger);"
                            onclick="julgarFrete('reprovado')">‚ùå Reprovar Frete</button>
                        <button class="btn btn-primary" style="background:var(--success); border-color:var(--success);"
                            onclick="julgarFrete('aprovado')">‚úÖ Aprovar Frete</button>
                    </div>
                </div>

                <!-- Controle Pr√≥-Rata (Faturamento) -->
                <div style="margin-top:32px; border-top:1px solid var(--gray-200); padding-top:24px;">
                    <h4 style="margin:0 0 16px 0; color:var(--gray-700);">Controle Pr√≥-Rata (Faturamento Inicial)
                    </h4>
                    <div
                        style="background:var(--gray-50); padding:20px; border-radius:8px; border:1px solid var(--gray-200); display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end;">
                        <div class="form-group" style="flex:1; min-width:200px;">
                            <label>Valor Acordado (Mensal) R$</label>
                            <input type="number" step="0.01" id="finValorAcordado" class="form-control"
                                placeholder="0.00" oninput="calcularProRata()">
                        </div>
                        <div class="form-group" style="flex:1; min-width:200px;">
                            <label>Data de Entrega (In√≠cio)</label>
                            <input type="date" id="finDataEntrega" class="form-control" readonly
                                style="background-color: var(--gray-100);"
                                title="Preenchimento autom√°tico na assinatura da O.S.">
                        </div>
                        <div class="form-group"
                            style="flex:1; min-width:280px; padding:12px; background:white; border-radius:6px; border:1px dashed var(--gray-300);">
                            <div style="font-size:12px; color:var(--gray-500); margin-bottom:4px;">C√°lculo At√© o
                                Final do M√™s</div>
                            <div style="font-size:18px; color:var(--primary-600); font-weight:bold;">
                                Pro-Rata: <span id="finValorProRata">R$ 0,00</span>
                            </div>
                            <div id="finDiasUso" style="font-size:12px; color:var(--gray-500); margin-top:4px;">0
                                dias de uso</div>
                        </div>
                        <div class="form-group" style="width:100%; text-align:right; margin-top:8px;">
                            <button class="btn btn-primary" onclick="salvarFinFaturamento()">Salvar
                                Faturamento</button>
                        </div>
                    </div>
                </div>

                <!-- Contas a Pagar (Custos Vinculados) -->
                <div style="margin-top:32px; border-top:1px solid var(--gray-200); padding-top:24px;">
                    <h4 style="margin:0 0 16px 0; color:var(--gray-700);">Contas a Pagar (Custos do Pedido)</h4>

                    <div id="addContaForm"
                        style="background:var(--gray-50); padding:16px; border-radius:8px; border:1px solid var(--gray-200); margin-bottom:16px;">
                        <div class="form-row" style="align-items:flex-end;">
                            <div class="form-group" style="flex:2;">
                                <label>Descri√ß√£o (Ex: Motoboy, Frete Loggi, Loc. Parceiro)</label>
                                <input type="text" id="contaDescricao" class="form-control" placeholder="...">
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>Tipo</label>
                                <select id="contaTipo" class="form-control">
                                    <option value="Frete">Frete Transporte</option>
                                    <option value="Locacao Parceiro">Loca√ß√£o de Parceiro</option>
                                    <option value="Servico Terceiro">Servi√ßos Terceirizados</option>
                                    <option value="Outros">Outros Custos</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>Valor (R$)</label>
                                <input type="number" step="0.01" id="contaValor" class="form-control"
                                    placeholder="0.00">
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>Vencimento</label>
                                <input type="date" id="contaVencimento" class="form-control">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="addContaPagar()">+ Lan√ßar</button>
                            </div>
                        </div>
                    </div>

                    <div class="equipamentos-grid">
                        <table style="margin:0; box-shadow:none;">
                            <thead style="background:var(--gray-50);">
                                <tr>
                                    <th>Data Lan√ßamento</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Tipo</th>
                                    <th>Vencimento</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="contasTbody"></tbody>
                            <tfoot style="background:var(--gray-50); font-weight:bold;">
                                <tr>
                                    <td colspan="4" style="text-align:right;">TOTAL DE CUSTOS:</td>
                                    <td colspan="3" style="font-size:16px; color:var(--danger);" id="totalCustosPedido">
                                        R$ 0,00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="pecas-readonly-container" style="margin-top:32px;"></div>
                <div class="read-only-equips-container" style="margin-top:32px;"></div>
            </div>

            <!-- Tab Content: Consultor -->
            <div id="tab-consultor" class="tab-content">
                <h4 style="margin-bottom:16px; color:var(--gray-700);">Checklist Consultor Externo</h4>
                <div id="checklists-consultor_externo" style="margin-bottom:24px;"></div>

                <!-- Signature Pad & Fechamento -->
                <div style="border-top:1px solid var(--gray-200); padding-top:24px;">
                    <h4 style="margin-bottom:16px; color:var(--gray-800);">Termo de Entrega (O.S. Final)</h4>

                    <div
                        style="background:var(--gray-50); padding:20px; border-radius:8px; border:1px solid var(--gray-200); display:flex; flex-direction:column; gap:16px;">
                        <div>
                            <label
                                style="display:block; margin-bottom:8px; font-weight:bold; color:var(--gray-700);">Assinatura
                                do Cliente / Recebedor</label>
                            <div
                                style="border:2px dashed var(--gray-300); background:white; border-radius:8px; width:100%; max-width:500px; overflow:hidden;">
                                <canvas id="signaturePadCanvas"
                                    style="width:100%; height:200px; display:block; touch-action:none;"></canvas>
                            </div>
                            <div style="margin-top:8px;">
                                <button class="btn btn-sm" onclick="clearSignature()"
                                    style="background:var(--gray-200); color:var(--gray-700);">üóëÔ∏è Limpar
                                    Assinatura</button>
                            </div>
                        </div>

                        <div class="form-group" style="max-width:500px;">
                            <label>Nome por Extenso do Recebedor</label>
                            <input type="text" id="recebedorNome" class="form-control" placeholder="Ex: Jo√£o da Silva">
                        </div>

                        <div style="margin-top:16px;">
                            <button class="btn btn-primary" id="btnAssinarOS" onclick="assinarEGerarOS()"
                                style="background:var(--success); border-color:var(--success); font-size:16px; padding:12px 24px;">
                                ‚úçÔ∏è Assinar e Finalizar Entrega (Gerar O.S.)
                            </button>
                            <div style="font-size:13px; color:var(--gray-500); margin-top:8px;">
                                *Ao clicar, o pedido ser√° faturado proporcionalmente √† data de hoje e movido para
                                Conclu√≠do.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="read-only-equips-container" style="margin-top:32px;"></div>
            </div>

            <!-- Tab Content: Controle de Qualidade -->
            <div id="tab-qualidade" class="tab-content">
                <h4 style="margin-bottom:16px; color:var(--gray-700);">Checklist Controle de Qualidade</h4>
                <div id="checklists-controle_qualidade"></div>
                <div class="read-only-equips-container" style="margin-top:32px;"></div>
            </div>

            <!-- Tab Content: Auditoria -->
            <div id="tab-auditoria" class="tab-content">
                <h4 style="margin-bottom:24px; color:var(--gray-700);">Hist√≥rico de Transi√ß√µes</h4>
                <div id="auditTimeline" style="padding-left:12px;"></div>
            </div>
        </div>

        <!-- Panel Footer (Fixed) -->
        <div
            style="padding:16px 24px; border-top:1px solid var(--gray-200); background:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:13px; color:var(--gray-500);" id="gatingMessage">Conclua 100% do checklist atual
                para
                avan√ßar.</div>
            <button class="btn btn-primary" id="btnAvancarFase" onclick="avancarFase()" disabled>Avan√ßar para
                Pr√≥xima
                Fase ‚ûî</button>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        if (!requireAuth()) throw new Error('N√£o autenticado');
        initUserInfo();
        setActiveNav();

        let currentPedidoId = null;
        let currentPedidoData = null;
        let pendingEquipments = [];

        const statusLabels = {
            'comercial': 'Comercial',
            'logistica': 'Log√≠stica',
            'laboratorio': 'Laborat√≥rio',
            'consultor_externo': 'Consultor Externo',
            'financeiro': 'Financeiro',
            'controle_qualidade': 'Controle de Qualidade',
            'concluido': 'Conclu√≠do ‚úÖ'
        };

        async function loadPedidos() {
            try {
                const res = await fetchApi('/api/pedidos');
                const pedidos = await res.json();
                const tbody = document.getElementById('pedidosTableBody');

                if (pedidos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state">Nenhum pedido em andamento.</div></td></tr>';
                    return;
                }

                tbody.innerHTML = pedidos.map(p => {
                    let slaBadge = '';
                    if (p.status_atual === 'concluido') {
                        slaBadge = '<span class="badge badge-sla-ok">Finalizado</span>';
                    } else if (p.em_atraso) {
                        slaBadge = `<span class="badge badge-sla-danger">EM ATRASO (${Math.abs(p.horas_restantes)}h)</span>`;
                    } else {
                        let okClass = p.horas_restantes < 12 ? 'badge-sla-warning' : 'badge-sla-ok';
                        slaBadge = `<span class="badge ${okClass}">No prazo (${p.horas_restantes}h rest)</span>`;
                    }

                    return `
                        <tr onclick="openPedidoDetails(${p.id})" style="cursor:pointer;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='none'">
                            <td><strong>#${p.id}</strong></td>
                            <td>${p.cliente_nome}</td>
                            <td><span class="badge badge-estoque">${statusLabels[p.status_atual] || p.status_atual}</span></td>
                            <td>${slaBadge}</td>
                            <td>${p.criador_nome}</td>
                            <td>${formatDate(p.created_at)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error(err);
            }
        }

        let clienteMode = 'existente';
        let solicitacoesPed = [];

        async function openNewPedidoModal() {
            document.getElementById('newPedidoModal').style.display = 'flex';
            // Reset form
            document.getElementById('newPedidoObs').value = '';
            clienteMode = 'existente';
            toggleClienteMode('existente');

            solicitacoesPed = [];
            renderSolicitacoesTable();

            document.getElementById('novoCNPJ').value = '';
            document.getElementById('novoNome').value = '';
            document.getElementById('novoTelefone').value = '';
            document.getElementById('novoEndereco').value = '';
            document.getElementById('addModeloInput').value = '';
            document.getElementById('addQtdInput').value = '1';

            // Load clients
            const res = await fetchApi('/api/clientes');
            const clientes = await res.json();
            const sel = document.getElementById('newPedidoCliente');
            sel.innerHTML = '<option value="">Selecione um cliente...</option>' +
                clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
        }

        function closeNewPedidoModal() {
            document.getElementById('newPedidoModal').style.display = 'none';
        }

        function toggleClienteMode(mode) {
            clienteMode = mode;
            if (mode === 'existente') {
                document.getElementById('modo-cliente-existente').style.display = 'block';
                document.getElementById('modo-cliente-novo').style.display = 'none';
                document.getElementById('btn-cliente-existente').classList.add('active');
                document.getElementById('btn-cliente-novo').classList.remove('active');
            } else {
                document.getElementById('modo-cliente-existente').style.display = 'none';
                document.getElementById('modo-cliente-novo').style.display = 'block';
                document.getElementById('btn-cliente-existente').classList.remove('active');
                document.getElementById('btn-cliente-novo').classList.add('active');
            }
        }

        async function buscarCNPJ() {
            const cnpjInput = document.getElementById('novoCNPJ').value.replace(/\D/g, '');
            if (cnpjInput.length !== 14) {
                return alert('CNPJ inv√°lido. Digite 14 n√∫meros.');
            }

            const btn = document.getElementById('btnBuscarCNPJ');
            btn.textContent = '...';
            btn.disabled = true;

            try {
                const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpjInput}`);
                if (!response.ok) throw new Error('Cnpj n√£o encontrado');
                const data = await response.json();

                document.getElementById('novoNome').value = data.razao_social || data.nome_fantasia || '';
                document.getElementById('novoTelefone').value = data.ddd_telefone_1 || data.ddd_telefone_2 || '';
                const logradouro = data.logradouro ? `${data.descricao_tipo_de_logradouro} ${data.logradouro}` : '';
                document.getElementById('novoEndereco').value = `${logradouro}, ${data.numero}, ${data.bairro}, ${data.municipio} - ${data.uf} CEP: ${data.cep}`;
            } catch (e) {
                alert('Erro ao buscar CNPJ.');
            } finally {
                btn.textContent = 'Buscar';
                btn.disabled = false;
            }
        }

        function addSolicitacaoRow() {
            const modelo = document.getElementById('addModeloInput').value.trim();
            const qtd = parseInt(document.getElementById('addQtdInput').value) || 1;

            if (!modelo) return alert('Digite o modelo solicitado.');

            solicitacoesPed.push({ modelo, quantidade: qtd });
            renderSolicitacoesTable();

            document.getElementById('addModeloInput').value = '';
            document.getElementById('addQtdInput').value = '1';
            document.getElementById('addModeloInput').focus();
        }

        function removeSolicitacaoRow(index) {
            solicitacoesPed.splice(index, 1);
            renderSolicitacoesTable();
        }

        function renderSolicitacoesTable() {
            const tbody = document.getElementById('solicitacoesTbody');
            if (solicitacoesPed.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--gray-400); padding:12px;">Nenhum radiocomunicador solicitado.</td></tr>';
                return;
            }

            tbody.innerHTML = solicitacoesPed.map((s, i) => `
                    <tr>
                        <td><strong>${s.modelo}</strong></td>
                        <td style="text-align:center;">${s.quantidade}</td>
                        <td style="text-align:center;">
                            <button class="btn btn-sm" style="color:var(--danger); padding:4px;" onclick="removeSolicitacaoRow(${i})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
        }

        async function createPedidoComplex() {
            const btn = document.getElementById('btnCriarPedido');
            btn.disabled = true;
            btn.textContent = 'Criando...';

            try {
                let cliente_id = null;
                const obs = document.getElementById('newPedidoObs').value;

                // Lidar com cria√ß√£o de cliente ou sele√ß√£o
                if (clienteMode === 'existente') {
                    cliente_id = document.getElementById('newPedidoCliente').value;
                    if (!cliente_id) throw new Error('Selecione um cliente existente.');
                } else {
                    const nome = document.getElementById('novoNome').value.trim();
                    const cnpj_cpf = document.getElementById('novoCNPJ').value.trim();
                    const telefone = document.getElementById('novoTelefone').value.trim();
                    const endereco = document.getElementById('novoEndereco').value.trim();

                    if (!nome) throw new Error('Nome/Raz√£o Social √© obrigat√≥rio para um novo cliente.');

                    const resCliente = await fetchApi('/api/clientes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nome, cnpj_cpf, telefone, endereco, plano_safe_ativo: 'N√£o' })
                    });

                    if (!resCliente.ok) throw new Error('Erro ao criar cliente novo.');
                    const newCliente = await resCliente.json();
                    cliente_id = newCliente.id;
                }

                // 1. Criar o Pedido Principal
                const tipoPedido = document.getElementById('tipoPedidoSelect').value;
                const resPedido = await fetchApi('/api/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cliente_id, observacoes: obs, tipo: tipoPedido })
                });

                if (!resPedido.ok) throw new Error('Erro ao criar pedido.');
                const { id: pedido_id } = await resPedido.json();

                // 2. Anexar as Solicita√ß√µes (Modelos Base)
                if (solicitacoesPed.length > 0) {
                    const resSol = await fetchApi(`/api/pedidos/${pedido_id}/solicitacoes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ solicitacoes: solicitacoesPed })
                    });
                    if (!resSol.ok) console.error('Aviso: Erro ao salvar solicita√ß√µes no pedido.');
                }

                closeNewPedidoModal();
                await loadPedidos();
                openPedidoDetails(pedido_id); // Abre o pedido rec√©m-criado
            } catch (e) {
                alert(e.message || 'Erro inesperado.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Gerar Proposta/Pedido';
            }
        }

        // --- Detalhes do Pedido ---

        async function openPedidoDetails(id) {
            currentPedidoId = id;
            document.getElementById('pedidoPanelOverlay').style.display = 'block';
            document.getElementById('pedidoPanel').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('pedidoPanelOverlay').style.opacity = '1';
                document.getElementById('pedidoPanel').style.right = '0';
            }, 10);

            await refreshPedidoData();
        }

        function closePedidoPanel() {
            currentPedidoId = null;
            document.getElementById('pedidoPanelOverlay').style.opacity = '0';
            document.getElementById('pedidoPanel').style.right = '-800px';
            setTimeout(() => {
                document.getElementById('pedidoPanelOverlay').style.display = 'none';
                document.getElementById('pedidoPanel').style.display = 'none';
            }, 300);
            loadPedidos(); // Refresh dashboard on close
        }

        async function refreshPedidoData() {
            if (!currentPedidoId) return;
            const res = await fetchApi(`/api/pedidos/${currentPedidoId}`);
            currentPedidoData = await res.json();
            renderPedidoPanel();
        }

        function renderPedidoPanel() {
            const { pedido, equipamentos, checklists, audit_logs } = currentPedidoData;

            // Header
            document.getElementById('panelPedidoId').textContent = pedido.id;
            document.getElementById('panelCliente').textContent = pedido.cliente_nome;

            // SLA
            const badgeEl = document.getElementById('panelSlaBadge');
            if (pedido.status_atual === 'concluido') {
                badgeEl.className = 'badge badge-sla-ok';
                badgeEl.textContent = 'CONCLU√çDO';
            } else {
                badgeEl.textContent = `Em ${statusLabels[pedido.status_atual]}`;
                badgeEl.className = 'badge badge-estoque';
            }

            // Tipo Badge
            const tipoLabels = { 'venda': 'üì¶ VENDA', 'venda_seminovos': '‚ôªÔ∏è SEMINOVOS', 'manutencao_radios': 'üîß MANUTEN√á√ÉO' };
            let tipoBadge = document.getElementById('panelTipoBadge');
            if (!tipoBadge) {
                tipoBadge = document.createElement('span');
                tipoBadge.id = 'panelTipoBadge';
                tipoBadge.className = 'badge';
                tipoBadge.style.cssText = 'margin-left:8px; background:var(--primary-100); color:var(--primary-700); font-size:11px;';
                badgeEl.parentElement.appendChild(tipoBadge);
            }
            tipoBadge.textContent = tipoLabels[pedido.tipo] || 'üì¶ VENDA';

            // Tabs state mapping
            const tabKeys = ['comercial', 'logistica', 'laboratorio', 'consultor_externo', 'financeiro', 'controle_qualidade'];
            const currentIdx = tabKeys.indexOf(pedido.status_atual);

            // Render Checklists
            tabKeys.forEach((fase, idx) => {
                let faseId = fase;
                if (fase === 'consultor_externo') faseId = 'consultor';
                if (fase === 'controle_qualidade') faseId = 'qualidade';

                const container = document.getElementById(`checklists-${fase}`);
                if (!container) return; // ignore auditoria

                const isPast = pedido.status_atual === 'concluido' || idx < currentIdx;
                const isCurrent = idx === currentIdx;
                const isFuture = idx > currentIdx;

                if (isFuture) {
                    container.innerHTML = '<div style="color:var(--gray-400); font-style:italic;">Fase ainda n√£o iniciada.</div>';
                } else {
                    const chks = checklists[fase] || [];
                    container.innerHTML = chks.map(c => `
                        <label class="checklist-item" style="${isPast ? 'opacity:0.7;' : ''}">
                            <input type="checkbox" ${c.concluido ? 'checked' : ''} 
                                   ${isPast ? 'disabled' : ''} 
                                   onchange="toggleChecklist(${c.id}, this.checked)">
                            <span>${c.descricao}</span>
                        </label>
                    `).join('');
                }

                // Tab button states
                const btn = document.getElementById(`btn-tab-${faseId}`);
                if (btn) {
                    if (isFuture) {
                        btn.classList.add('disabled');
                    } else {
                        btn.classList.remove('disabled');
                    }
                }
            });

            // Switch to current tab automatically
            if (pedido.status_atual !== 'concluido') {
                let switchTarget = pedido.status_atual;
                if (switchTarget === 'consultor_externo') switchTarget = 'consultor';
                if (switchTarget === 'controle_qualidade') switchTarget = 'qualidade';
                switchTab(`tab-${switchTarget}`);
            } else {
                switchTab('tab-auditoria');
            }

            // Render Equipments logistica (Editable)
            pendingEquipments = [...equipamentos];
            renderEditEquipsGrid();

            // Generate pieces select options
            populatePecasDropdown();

            // Load Frequencies & Chips (if Laboratory tab has priority or any tab really)
            loadFrequencias();
            loadChips();

            // Load Contas a Pagar (Financeiro)
            loadContasPagar();

            // Init Signature Pad if Consultor Tab
            if (pedido.status_atual === 'consultor_externo') {
                // Small delay to ensure modal is visible for canvas size
                setTimeout(initSignaturePad, 300);
            }

            // Fill Pro-Rata inputs
            document.getElementById('finValorAcordado').value = pedido.valor_acordado || '';

            if (pedido.data_entrega) {
                // Extract YYYY-MM-DD for the input type="date"
                const strDate = new Date(pedido.data_entrega).toISOString().split('T')[0];
                document.getElementById('finDataEntrega').value = strDate;
            } else {
                document.getElementById('finDataEntrega').value = '';
            }

            calcularProRata();

            // Frete (Log√≠stica & Financeiro)
            const logTransportadoraInput = document.getElementById('logTransportadora');
            const logFreteValorInput = document.getElementById('logFreteValor');
            const logFretePesoInput = document.getElementById('logFretePeso');
            const logFreteDimInput = document.getElementById('logFreteDimensoes');
            const badgeFrete = document.getElementById('freteStatusBadge');

            logTransportadoraInput.value = pedido.transportadora || '';
            logFreteValorInput.value = pedido.frete_valor || '';

            let df = {};
            try { if (pedido.dados_frete) df = JSON.parse(pedido.dados_frete); } catch (e) { }
            logFretePesoInput.value = df.peso || '';
            logFreteDimInput.value = df.dimensoes || '';

            if (pedido.frete_status === 'aprovado') {
                badgeFrete.innerHTML = '<span style="color:var(--success);">‚úÖ Frete Aprovado</span>';
            } else if (pedido.frete_status === 'reprovado') {
                badgeFrete.innerHTML = '<span style="color:var(--danger);">‚ùå Frete Reprovado</span>';
            } else if (pedido.frete_status === 'pendente' && pedido.transportadora) {
                badgeFrete.innerHTML = '<span style="color:var(--warning);">‚è≥ Frete Pendente Aprova√ß√£o</span>';
            } else {
                badgeFrete.innerHTML = '';
            }

            // Desabilita form de frete se n√£o for log√≠stica
            const isLogisticaAtual = pedido.status_atual === 'logistica';
            logTransportadoraInput.readOnly = !isLogisticaAtual;
            logFreteValorInput.readOnly = !isLogisticaAtual;
            logFretePesoInput.readOnly = !isLogisticaAtual;
            logFreteDimInput.readOnly = !isLogisticaAtual;
            document.getElementById('btnSalvarFrete').style.display = 'none';

            // Render Frete para Aprova√ß√£o no Financeiro
            const finFreteContainer = document.getElementById('financeiroFreteContainer');
            if (pedido.transportadora && pedido.frete_valor) {
                finFreteContainer.style.display = 'block';
                document.getElementById('finFreteDetalhes').innerHTML = `
                        <strong>Transportadora:</strong> ${pedido.transportadora}<br>
                        <strong>Valor:</strong> R$ ${pedido.frete_valor.toFixed(2)}<br>
                        <strong>Peso:</strong> ${df.peso || 'N/A'} kg | <strong>Dimens√µes:</strong> ${df.dimensoes || 'N/A'}
                    `;

                const finBadge = document.getElementById('finFreteStatusBadge');
                const finAcoes = document.getElementById('finFreteAcoes');

                if (pedido.frete_status === 'aprovado') {
                    finBadge.innerHTML = '‚úÖ APROVADO';
                    finBadge.style.color = 'var(--success)';
                    finAcoes.style.display = 'none';
                } else if (pedido.frete_status === 'reprovado') {
                    finBadge.innerHTML = '‚ùå REPROVADO';
                    finBadge.style.color = 'var(--danger)';
                    finAcoes.style.display = 'none';
                } else {
                    finBadge.innerHTML = '‚è≥ PENDENTE APROVA√á√ÉO';
                    finBadge.style.color = 'var(--warning)';
                    finAcoes.style.display = pedido.status_atual === 'financeiro' ? 'flex' : 'none';
                }
            } else {
                finFreteContainer.style.display = 'none';
            }

            // Render Readonly Equipments for other tabs
            const readOnlyHtml = `
                <h4 style="margin-bottom:12px; color:var(--gray-700);">Equipamentos Vinculados (Somente Leitura)</h4>
                <div class="equipamentos-grid">
                    <table style="margin:0; box-shadow:none;">
                        <thead style="background:var(--gray-50);">
                            <tr><th>N¬∫ S√©rie</th><th>Modelo</th><th>Acess√≥rios</th></tr>
                        </thead>
                        <tbody>
                            ${equipamentos.length === 0 ? '<tr><td colspan="3" style="text-align:center;color:var(--gray-400);">Nenhum equipamento</td></tr>' :
                    equipamentos.map(eq => `
                                    <tr>
                                        <td>${eq.serial_number}</td>
                                        <td>${eq.modelo}</td>
                                        <td>${eq.acessorios}</td>
                                    </tr>
                                `).join('')
                }
                        </tbody>
                    </table>
                </div>
            `;
            document.querySelectorAll('.read-only-equips-container').forEach(el => el.innerHTML = readOnlyHtml);

            // Audit Timeline
            document.getElementById('auditTimeline').innerHTML = audit_logs.map(log => `
                <div class="timeline-item">
                    <div style="width:24px; height:24px; border-radius:50%; background:var(--primary-100); color:var(--primary-600); display:flex; align-items:center; justify-content:center; font-size:12px; z-index:1; border:2px solid white; margin-top:2px;">‚Ä¢</div>
                    <div>
                        <div style="font-weight:600; font-size:14px; color:var(--gray-800);">${log.acao === 'CRIACAO' ? 'Pedido Criado' : 'Avan√ßo de Fase'}</div>
                        <div style="font-size:13px; color:var(--gray-600); margin-top:4px;">
                            ${log.acao === 'AVANCO_FASE' ? `De <b>${statusLabels[log.status_anterior] || log.status_anterior}</b> para <b>${statusLabels[log.status_novo] || log.status_novo}</b>` : `Iniciado em <b>Log√≠stica</b>`}
                        </div>
                        <div style="font-size:12px; color:var(--gray-400); margin-top:4px;">${formatDate(log.created_at)} por ${log.usuario_nome}</div>
                    </div>
                </div>
            `).join('');

            updateGatingButton();
            renderPecasTable();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        // --- Equipamentos Logic ---
        function renderEditEquipsGrid() {
            const tbody = document.getElementById('equipLogisticaBody');
            const btnSave = document.getElementById('btnSaveEquips');

            if (currentPedidoData.pedido.status_atual !== 'logistica') {
                document.getElementById('btnEditEquips').style.display = 'none';
                btnSave.style.display = 'none';
                // Render as readonly essentially
                tbody.innerHTML = pendingEquipments.map((eq) => `
                    <tr>
                        <td>${eq.serial_number}</td>
                        <td>${eq.modelo}</td>
                        <td>${eq.acessorios}</td>
                        <td>-</td>
                    </tr>
                `).join('');
                if (pendingEquipments.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum equipamento vinculado</td></tr>';
                return;
            }

            document.getElementById('btnEditEquips').style.display = 'block';
            btnSave.style.display = 'block';

            if (pendingEquipments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--gray-400);">Adicione equipamentos clicando acima</td></tr>';
                return;
            }

            tbody.innerHTML = pendingEquipments.map((eq, i) => `
                <tr>
                    <td style="padding:4px 8px;"><input type="text" class="form-control" style="font-size:13px; padding:6px;" value="${eq.serial_number || ''}" oninput="updateEq(${i}, 'serial_number', this.value)"></td>
                    <td style="padding:4px 8px;"><input type="text" class="form-control" style="font-size:13px; padding:6px;" value="${eq.modelo || ''}" oninput="updateEq(${i}, 'modelo', this.value)"></td>
                    <td style="padding:4px 8px;"><input type="text" class="form-control" style="font-size:13px; padding:6px;" value="${eq.acessorios || ''}" oninput="updateEq(${i}, 'acessorios', this.value)"></td>
                    <td style="padding:4px 8px; text-align:center;"><button class="btn" style="color:var(--danger); padding:4px;" onclick="removeEq(${i})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function addEquipRow() {
            pendingEquipments.push({ serial_number: '', modelo: '', acessorios: '' });
            renderEditEquipsGrid();
        }

        function updateEq(idx, field, val) {
            pendingEquipments[idx][field] = val;
        }

        function removeEq(idx) {
            pendingEquipments.splice(idx, 1);
            renderEditEquipsGrid();
        }

        async function saveEquipamentos() {
            const btn = document.getElementById('btnSaveEquips');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            const res = await fetchApi(`/api/pedidos/${currentPedidoId}/equipamentos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ equipamentos: pendingEquipments })
            });

            btn.textContent = 'Salvar Equipamentos';
            btn.disabled = false;

            if (res.ok) {
                showToast('Equipamentos salvos', 'success');
                await refreshPedidoData();
            } else {
                showToast('Erro ao salvar', 'error');
            }
        }

        // --- Log√≠stica: Cota√ß√£o de Frete ---
        function showBtnSalvarFrete() {
            if (currentPedidoData.pedido.status_atual !== 'logistica') return;
            document.getElementById('btnSalvarFrete').style.display = 'block';
        }

        async function salvarCotacaoFrete() {
            const btn = document.getElementById('btnSalvarFrete');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            const transportadora = document.getElementById('logTransportadora').value.trim();
            const frete_valor = parseFloat(document.getElementById('logFreteValor').value) || 0;
            const peso = document.getElementById('logFretePeso').value;
            const dimensoes = document.getElementById('logFreteDimensoes').value;

            try {
                const dados_frete = JSON.stringify({ peso, dimensoes });
                const res = await fetchApi(`/api/pedidos/${currentPedidoId}/frete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transportadora, frete_valor, dados_frete, frete_status: 'pendente'
                    })
                });

                if (res.ok) {
                    showToast('Cota√ß√£o de frete salva!', 'success');
                    btn.style.display = 'none';
                    await refreshPedidoData(); // Atualiza labels/badges
                } else throw new Error('Erro na API');
            } catch (e) {
                showToast('Erro ao salvar frete', 'error');
            } finally {
                btn.textContent = 'Salvar Cota√ß√£o de Frete';
                btn.disabled = false;
            }
        }

        async function julgarFrete(status) {
            if (!confirm(`Tem certeza que deseja marcar o frete como ${status.toUpperCase()}?`)) return;

            try {
                const res = await fetchApi(`/api/pedidos/${currentPedidoId}/frete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frete_status: status })
                });

                if (res.ok) {
                    showToast(`Frete ${status.toUpperCase()} com sucesso!`, 'success');

                    // Opcional: registrar log de auditoria
                    await fetchApi(`/api/pedidos/${currentPedidoId}/checklists/0/toggle`, { // dummy call to register a manual audit action IF we had an endpoint, but simply refreshing does the visual update
                        method: 'POST', body: JSON.stringify({})
                    }).catch(e => e);

                    await refreshPedidoData();
                } else throw new Error();
            } catch (e) {
                showToast('Erro ao atualizar status do frete', 'error');
            }
        }

        // --- Financeiro: Pro-Rata & Faturamento ---
        function calcularProRata() {
            const valorInput = document.getElementById('finValorAcordado').value;
            const dataEntregaInput = document.getElementById('finDataEntrega').value;
            const proRataSpan = document.getElementById('finValorProRata');
            const diasUsoSpan = document.getElementById('finDiasUso');

            if (!valorInput || !dataEntregaInput) {
                proRataSpan.textContent = 'R$ 0,00';
                diasUsoSpan.textContent = '0 dias de uso';
                return;
            }

            const valor = parseFloat(valorInput);
            const dataInicio = new Date(dataEntregaInput);
            const dataFim = new Date(dataInicio.getFullYear(), dataInicio.getMonth() + 1, 0); // √öltimo dia do m√™s da entrega

            // Se a data de entrega for inv√°lida
            if (isNaN(dataInicio.getTime())) return;

            // Dias do m√™s e dias de uso
            const diasNoMes = dataFim.getDate();
            let diasUso = diasNoMes - dataInicio.getDate() + 1; // Inclui o dia de in√≠cio

            if (diasUso < 0) diasUso = 0;

            const valorDiario = valor / diasNoMes;
            const proRata = valorDiario * diasUso;

            proRataSpan.textContent = `R$ ${proRata.toFixed(2)}`;
            diasUsoSpan.textContent = `${diasUso} dias de uso (de ${diasNoMes} dias no m√™s)`;
        }

        async function salvarFinFaturamento() {
            const valorAcordado = parseFloat(document.getElementById('finValorAcordado').value);
            if (isNaN(valorAcordado)) {
                showToast('Informe um valor num√©rico v√°lido.', 'warning');
                return;
            }

            try {
                // Reutilizamos a rota de avan√ßo/assinatura ou uma espec√≠fica para atualizar valor_acordado
                // Criaremos uma instru√ß√£o direta via banco para atualizar s√≥ o valor
                const res = await fetchApi(`/api/pedidos/${currentPedidoId}/assinar-concluir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor_acordado: valorAcordado })
                });

                if (res.ok) {
                    showToast('Valor faturado atualizado com sucesso.', 'success');
                    await refreshPedidoData();
                }
            } catch (e) {
                showToast('Erro ao salvar faturamento.', 'error');
            }
        }

        // --- Financeiro: Contas a Pagar ---
        let contasPagarData = [];
        async function loadContasPagar() {
            if (!currentPedidoData || !currentPedidoData.pedido) return;
            try {
                const res = await fetchApi(`/api/financeiro/pedidos/${currentPedidoId}/contas`);
                contasPagarData = await res.json();
                renderContasPagarTable();
            } catch (e) { console.error('Erro ao carregar contas a pagar', e); }
        }

        function renderContasPagarTable() {
            const tbody = document.getElementById('contasTbody');
            const totalEl = document.getElementById('totalCustosPedido');

            let total = 0;

            if (!contasPagarData || contasPagarData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);">Nenhum custo lan√ßado</td></tr>';
                totalEl.textContent = 'R$ 0,00';
                return;
            }

            tbody.innerHTML = contasPagarData.map(c => {
                const formatData = d => d ? new Date(d).toLocaleDateString('pt-BR') : '-';
                const badgeClass = c.status === 'Pago' ? 'badge-sla-ok' : 'badge-sla-warning';
                const oppositeStatus = c.status === 'Pago' ? 'Pendente' : 'Pago';
                const toggleColor = c.status === 'Pago' ? 'var(--warning)' : 'var(--success)';
                const toggleIcon = c.status === 'Pago' ? '‚Ü©Ô∏è' : 'üí∞'; // Revert or Pay

                total += c.valor;

                return `
                    <tr>
                        <td>${formatData(c.created_at)}</td>
                        <td><strong>${c.descricao}</strong></td>
                        <td>${c.tipo}</td>
                        <td>${formatData(c.vencimento)}</td>
                        <td>R$ ${c.valor.toFixed(2)}</td>
                        <td><span class="${badgeClass}" style="padding:4px 8px; border-radius:4px; font-size:12px;">${c.status}</span></td>
                        <td style="text-align:center; display:flex; gap:8px; justify-content:center;">
                            <button class="btn btn-sm" style="color:${toggleColor}; padding:4px;" onclick="toggleContaStatus(${c.id}, '${oppositeStatus}')" title="Marcar como ${oppositeStatus}">${toggleIcon}</button>
                            <button class="btn btn-sm" style="color:var(--danger); padding:4px;" onclick="removeConta(${c.id})" title="Remover Lan√ßamento">üóëÔ∏è</button>
                        </td>
                    </tr>
                `}).join('');

            totalEl.textContent = `R$ ${total.toFixed(2)}`;
        }

        async function addContaPagar() {
            const descricao = document.getElementById('contaDescricao').value;
            const tipo = document.getElementById('contaTipo').value;
            const valor = parseFloat(document.getElementById('contaValor').value);
            const vencimento = document.getElementById('contaVencimento').value;

            if (!descricao || isNaN(valor)) { showToast('Descri√ß√£o e Valor s√£o obrigat√≥rios', 'warning'); return; }

            try {
                const res = await fetchApi(`/api/financeiro/pedidos/${currentPedidoId}/contas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ descricao, tipo, valor, vencimento })
                });
                if (res.ok) {
                    showToast('Custo lan√ßado com sucesso', 'success');
                    ['contaDescricao', 'contaValor', 'contaVencimento'].forEach(id => document.getElementById(id).value = '');
                    await loadContasPagar();
                }
            } catch (e) { showToast('Erro ao lan√ßar conta', 'error'); }
        }

        async function toggleContaStatus(id, newStatus) {
            try {
                const res = await fetchApi(`/api/financeiro/contas/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (res.ok) { showToast(`Conta marcada como ${newStatus}`, 'success'); await loadContasPagar(); }
            } catch (e) { showToast('Erro ao atualizar conta', 'error'); }
        }

        async function removeConta(id) {
            if (!confirm('Remover este lan√ßamento de custo do pedido?')) return;
            try {
                const res = await fetchApi(`/api/financeiro/contas/${id}`, { method: 'DELETE' });
                if (res.ok) { showToast('Conta removida', 'success'); await loadContasPagar(); }
            } catch (e) { showToast('Erro', 'error'); }
        }

        // --- Log√≠stica: Escaneamento Universal ---
        let scannerBuffer = '';
        let scannerTimeout;

        // Escuta global para leitor USB
        document.addEventListener('keydown', (e) => {
            if (!currentPedidoId || currentPedidoData.pedido.status_atual !== 'logistica') return;

            // Ignora se estiver digitando num input normal
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'Enter') {
                if (scannerBuffer.length > 2) {
                    processarBipagem(scannerBuffer);
                }
                scannerBuffer = '';
            } else if (e.key.length === 1) { // Letras e n√∫meros apenas
                scannerBuffer += e.key;
                clearTimeout(scannerTimeout);
                scannerTimeout = setTimeout(() => { scannerBuffer = ''; }, 300);
            }
        });

        // html5-qrcode para c√¢mera
        let html5QrcodeScanner;
        function abrirCameraScanner() {
            const scannerDiv = document.createElement('div');
            scannerDiv.id = 'reader-container';
            scannerDiv.className = 'scanner-modal';
            scannerDiv.style.cssText = 'position:fixed; top:10%; left:50%; transform:translate(-50%, 0); width:90%; max-width:600px; background:white; padding:16px; z-index:3000; box-shadow:0 10px 30px rgba(0,0,0,0.5); border-radius:12px;';

            scannerDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                        <h3 style="margin:0;">Escaneamento via C√¢mera</h3>
                        <button onclick="fecharCameraScanner()" style="background:none; border:none; font-size:24px; cursor:pointer;">‚úï</button>
                    </div>
                    <div id="reader"></div>
                `;
            document.body.appendChild(scannerDiv);

            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 150 } }, false);
            html5QrcodeScanner.render((decodedText) => {
                fecharCameraScanner();
                processarBipagem(decodedText);
            }, () => { /* ignore */ });
        }

        window.fecharCameraScanner = function () {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(e => console.error(e));
            }
            const div = document.getElementById('reader-container');
            if (div) div.remove();
        }

        async function processarBipagem(codigoOuSerial) {
            try {
                let radio = null;

                // 1. Tenta por c√≥digo de patrim√¥nio
                let res = await fetchApi(`/api/radios/codigo/${codigoOuSerial}`);
                if (res.ok) {
                    radio = await res.json();
                } else {
                    // 2. Tenta busca gen√©rica
                    res = await fetchApi(`/api/radios?busca=${codigoOuSerial}`);
                    if (res.ok) {
                        const list = await res.json();
                        radio = list.find(r => r.codigo === codigoOuSerial || r.numero_serie === codigoOuSerial);
                    }
                }

                if (!radio) {
                    emitirAlertaLogistica(`R√°dio n√£o encontrado: ${codigoOuSerial}`, 'danger');
                    return;
                }

                // Previne duplica√ß√£o
                if (pendingEquipments.some(eq => eq.serial_number === radio.numero_serie)) {
                    emitirAlertaLogistica(`O r√°dio ${radio.modelo} (${radio.numero_serie}) j√° foi adicionado!`, 'warning');
                    return;
                }

                // Valida√ß√£o contra Solicita√ß√µes do Comercial (currentPedidoData.solicitacoes)
                const solicitacoes = currentPedidoData.solicitacoes || [];
                const countPendentesMesmoModelo = pendingEquipments.filter(eq => eq.modelo === radio.modelo).length;

                if (solicitacoes.length > 0) {
                    const modeloReq = solicitacoes.find(s => s.modelo.toLowerCase() === radio.modelo.toLowerCase());
                    if (!modeloReq) {
                        emitirAlertaLogistica(`üî¥ DIVERG√äNCIA: O modelo ${radio.modelo} N√ÉO foi solicitado pelo Comercial!`, 'danger');
                        // return; // Bloqueio desativado, permite passar mas alerta
                    } else if (countPendentesMesmoModelo >= modeloReq.quantidade) {
                        emitirAlertaLogistica(`üü° AVISO: A quantidade de ${radio.modelo} escaneada (${countPendentesMesmoModelo + 1}) excede o solicitado (${modeloReq.quantidade}).`, 'warning');
                    }
                }

                // Adiciona
                pendingEquipments.push({ serial_number: radio.numero_serie, modelo: radio.modelo, acessorios: '' });
                renderEditEquipsGrid();
                emitirAlertaLogistica(`‚úÖ ${radio.modelo} (${radio.numero_serie}) adicionado √† separa√ß√£o.`, 'success');

                document.getElementById('btnSaveEquips').style.display = 'block';
            } catch (e) {
                emitirAlertaLogistica(`Erro ao processar bipagem.`, 'danger');
            }
        }

        function emitirAlertaLogistica(msg, type) {
            const container = document.getElementById('scannerAlerts');
            const alertDiv = document.createElement('div');
            const color = type === 'success' ? '#137333' : (type === 'warning' ? '#b06000' : '#c5221f');
            const bg = type === 'success' ? '#e6f4ea' : (type === 'warning' ? '#fef7e0' : '#fce8e6');

            alertDiv.style.padding = '8px 12px';
            alertDiv.style.marginBottom = '8px';
            alertDiv.style.borderRadius = '4px';
            alertDiv.style.backgroundColor = bg;
            alertDiv.style.color = color;
            alertDiv.style.fontWeight = 'bold';
            alertDiv.style.fontSize = '14px';
            alertDiv.textContent = msg;

            container.prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 6500);
        }

        // --- Laborat√≥rio e Pe√ßas ---
        let allPrecos = [];

        async function loadPrecosIndenizatorios() {
            try {
                const res = await fetchApi('/api/precos');
                allPrecos = await res.json();
            } catch (error) {
                console.error('Erro ao carregar pre√ßos:', error);
            }
        }

        function populatePecasDropdown() {
            const select = document.getElementById('novoPecaSelect');
            const modelsInPedido = [...new Set(pendingEquipments.map(eq => eq.modelo))];

            // Filter pieces based on equipment models in the order
            let validPrecos = allPrecos;
            if (modelsInPedido.length > 0) {
                validPrecos = allPrecos.filter(p => modelsInPedido.includes(p.modelo_equipamento) || p.modelo_equipamento.toLowerCase() === 'geral');
            }

            select.innerHTML = '<option value="">Selecione a Pe√ßa...</option>' +
                validPrecos.map(p => `<option value="${p.id}">${p.componente} (${p.modelo_equipamento}) - R$ ${p.valor_base.toFixed(2)} + MO R$ ${p.valor_mao_de_obra.toFixed(2)}</option>`).join('');
        }

        function renderPecasTable() {
            const tbody = document.getElementById('pecasTbody');
            const totalEl = document.getElementById('totalPecasValor');
            const alertEl = document.getElementById('planoSafeAlert');
            const formEl = document.getElementById('addPecaForm');
            const financeiroContainers = document.querySelectorAll('.pecas-readonly-container');

            const isLabTab = currentPedidoData.pedido.status_atual === 'laboratorio';
            const planoSafeAtivo = currentPedidoData.pedido.plano_safe_ativo === 'Sim';

            alertEl.style.display = planoSafeAtivo ? 'flex' : 'none';
            formEl.style.display = isLabTab ? 'block' : 'none';

            if (!currentPedidoData.pecas) currentPedidoData.pecas = [];
            const pecas = currentPedidoData.pecas;

            let total = 0;

            if (pecas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);">Nenhuma pe√ßa/servi√ßo aplicado</td></tr>';
            } else {
                tbody.innerHTML = pecas.map(p => {
                    const subtotal = (p.valor_base + p.valor_mao_de_obra) * p.quantidade;
                    // If plano safe is active or this specific part is exempted
                    const isento = planoSafeAtivo || p.isenta_plano_safe === 1;
                    if (!isento) total += subtotal;

                    const subtotalDisplay = isento ? '<span style="color:var(--success); font-weight:bold;">ISENTO</span>' : `R$ ${subtotal.toFixed(2)}`;

                    return `
                        <tr>
                            <td style="text-align:center;">
                                ${isLabTab ? `<button class="btn btn-sm" style="color:var(--danger); padding:4px;" onclick="removePeca(${p.id})" title="Remover">üóëÔ∏è</button>` : '-'}
                            </td>
                            <td><strong>${p.componente}</strong></td>
                            <td>${p.modelo_equipamento || '-'}</td>
                            <td>R$ ${p.valor_base.toFixed(2)}</td>
                            <td>R$ ${p.valor_mao_de_obra.toFixed(2)}</td>
                            <td style="text-align:center;">${p.quantidade}</td>
                            <td style="text-align:right;">${subtotalDisplay}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Update Total
            totalEl.textContent = planoSafeAtivo ? 'R$ 0,00 (ISENTO)' : `R$ ${total.toFixed(2)}`;
            if (planoSafeAtivo) totalEl.style.color = 'var(--success)';
            else totalEl.style.color = 'var(--gray-800)';

            // Populate Read-only Financeiro Container
            const financeiroHtml = `
                <h4 style="margin-bottom:12px; color:var(--gray-700);">Pe√ßas e Servi√ßos Apurados</h4>
                <div class="equipamentos-grid">
                    <table style="margin:0; box-shadow:none;">
                        <thead style="background:var(--gray-50);">
                            <tr><th>Pe√ßa/Componente</th><th>Modelo</th><th>Qtd</th><th>Total Apurado</th></tr>
                        </thead>
                        <tbody>
                            ${pecas.length === 0 ? '<tr><td colspan="4" style="text-align:center;color:var(--gray-400);">Nenhuma pe√ßa cobrada</td></tr>' :
                    pecas.map(p => {
                        const sub = (p.valor_base + p.valor_mao_de_obra) * p.quantidade;
                        const isento = planoSafeAtivo || p.isenta_plano_safe === 1;
                        return `
                                        <tr>
                                            <td>${p.componente}</td>
                                            <td>${p.modelo_equipamento}</td>
                                            <td style="text-align:center;">${p.quantidade}</td>
                                            <td style="text-align:right;">${isento ? '<span style="color:var(--success); font-weight:bold;">ISENTO</span>' : `R$ ${sub.toFixed(2)}`}</td>
                                        </tr>
                                    `;
                    }).join('')
                }
                        </tbody>
                        <tfoot style="background:var(--gray-50); font-weight:bold;">
                            <tr>
                                <td colspan="3" style="text-align:right;">TOTAL A FATURAR:</td>
                                <td style="text-align:right; font-size:16px; ${planoSafeAtivo ? 'color:var(--success);' : ''}">${planoSafeAtivo ? 'ISENTO' : `R$ ${total.toFixed(2)}`}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            financeiroContainers.forEach(el => el.innerHTML = financeiroHtml);
        }

        async function addPecaAoPedido() {
            const precoId = document.getElementById('novoPecaSelect').value;
            const qtd = parseInt(document.getElementById('novoPecaQtd').value) || 1;

            if (!precoId) {
                showToast('Selecione uma pe√ßa', 'warning');
                return;
            }

            const isenta = currentPedidoData.pedido.plano_safe_ativo === 'Sim';

            try {
                const res = await fetchApi(`/api/pedidos/${currentPedidoId}/pecas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        preco_indenizatorio_id: precoId,
                        quantidade: qtd,
                        isenta_plano_safe: isenta,
                        // We associate the piece to the first available equipment linked, if any.
                        equipamento_id: pendingEquipments.length > 0 ? pendingEquipments[0].id : null
                    })
                });

                if (res.ok) {
                    showToast('Pe√ßa adicionada', 'success');
                    // Reset form
                    document.getElementById('novoPecaSelect').value = '';
                    document.getElementById('novoPecaQtd').value = '1';
                    await refreshPedidoData(); // Refresh to get updated list
                } else {
                    const err = await res.json();
                    showToast(err.error || 'Erro ao adicionar pe√ßa', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('Erro interno', 'error');
            }
        }

        async function removePeca(pecaId) {
            if (!confirm('Remover esta pe√ßa aplicada?')) return;
            try {
                const res = await fetchApi(`/api/pedidos/${currentPedidoId}/pecas/${pecaId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Pe√ßa removida', 'success');
                    await refreshPedidoData();
                } else {
                    showToast('Erro ao remover', 'error');
                }
            } catch (e) { console.error(e); }
        }

        // --- Frequ√™ncias do Cliente ---
        let clienteFrequencias = [];
        async function loadFrequencias() {
            if (!currentPedidoData || !currentPedidoData.pedido) return;
            const clienteId = currentPedidoData.pedido.cliente_id;
            try {
                const res = await fetchApi(`/api/lab/clientes/${clienteId}/frequencias`);
                clienteFrequencias = await res.json();
                renderFrequenciasTable();
            } catch (e) { console.error('Erro ao carregar frequencias', e); }
        }

        function renderFrequenciasTable() {
            const tbody = document.getElementById('frequenciasTbody');
            if (!clienteFrequencias || clienteFrequencias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);">Nenhuma frequ√™ncia cadastrada</td></tr>';
                return;
            }
            tbody.innerHTML = clienteFrequencias.map(f => `
                    <tr>
                        <td>${f.canal || '-'}</td>
                        <td>${f.tx || '-'}</td>
                        <td>${f.rx || '-'}</td>
                        <td>${f.subtom_tx || '-'}</td>
                        <td>${f.subtom_rx || '-'}</td>
                        <td>${f.observacoes || '-'}</td>
                        <td style="text-align:center;">
                            <button class="btn btn-sm" style="color:var(--danger); padding:4px;" onclick="removeFrequencia(${f.id})" title="Remover">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
        }

        async function addFrequencia() {
            const tx = document.getElementById('freqTx').value;
            const rx = document.getElementById('freqRx').value;
            const subtom_tx = document.getElementById('freqSubTx').value;
            const subtom_rx = document.getElementById('freqSubRx').value;
            const canal = document.getElementById('freqCanal').value;
            const observacoes = document.getElementById('freqObs').value;

            if (!tx && !rx) { showToast('Informe pelo menos TX ou RX', 'warning'); return; }

            try {
                const clienteId = currentPedidoData.pedido.cliente_id;
                const res = await fetchApi(`/api/lab/clientes/${clienteId}/frequencias`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tx, rx, subtom_tx, subtom_rx, canal, observacoes })
                });
                if (res.ok) {
                    showToast('Frequ√™ncia adicionada', 'success');
                    ['freqTx', 'freqRx', 'freqSubTx', 'freqSubRx', 'freqCanal', 'freqObs'].forEach(id => document.getElementById(id).value = '');
                    await loadFrequencias();
                }
            } catch (e) { showToast('Erro ao salvar frequ√™ncia', 'error'); }
        }

        async function removeFrequencia(id) {
            if (!confirm('Remover frequ√™ncia?')) return;
            try {
                const res = await fetchApi(`/api/lab/frequencias/${id}`, { method: 'DELETE' });
                if (res.ok) { showToast('Frequ√™ncia removida', 'success'); await loadFrequencias(); }
            } catch (e) { showToast('Erro', 'error'); }
        }

        // --- Chips POC ---
        let pedidoChips = [];
        async function loadChips() {
            try {
                const res = await fetchApi(`/api/lab/pedidos/${currentPedidoId}/chips`);
                pedidoChips = await res.json();
                renderChipsTable();
            } catch (e) { console.error('Erro ao carregar chips', e); }
        }

        function renderChipsTable() {
            const tbody = document.getElementById('chipsTbody');
            if (!pedidoChips || pedidoChips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray-400);">Nenhum chip POC vinculado</td></tr>';
                return;
            }
            tbody.innerHTML = pedidoChips.map(c => {
                const badgeClass = c.status === 'Ativo' ? 'badge-sla-ok' : 'badge-sla-warning';
                const oppositeStatus = c.status === 'Ativo' ? 'Suspenso' : 'Ativo';
                const toggleColor = c.status === 'Ativo' ? 'var(--warning)' : 'var(--success)';
                const toggleIcon = c.status === 'Ativo' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';

                return `
                    <tr>
                        <td><strong>${c.iccid}</strong></td>
                        <td>${c.linha || '-'}</td>
                        <td>${c.operadora || '-'}</td>
                        <td>${c.plano || '-'}</td>
                        <td><span class="${badgeClass}" style="padding:4px 8px; border-radius:4px; font-size:12px;">${c.status}</span></td>
                        <td style="text-align:center; display:flex; gap:8px; justify-content:center;">
                            <button class="btn btn-sm" style="color:${toggleColor}; padding:4px;" onclick="toggleChipStatus(${c.id}, '${oppositeStatus}')" title="${oppositeStatus}">${toggleIcon}</button>
                            <button class="btn btn-sm" style="color:var(--danger); padding:4px;" onclick="removeChip(${c.id})" title="Remover">üóëÔ∏è</button>
                        </td>
                    </tr>
                `}).join('');
        }

        async function addChip() {
            const iccid = document.getElementById('chipIccid').value;
            const linha = document.getElementById('chipLinha').value;
            const operadora = document.getElementById('chipOperadora').value;
            const plano = document.getElementById('chipPlano').value;

            if (!iccid) { showToast('ICCID √© obrigat√≥rio', 'warning'); return; }

            try {
                const cliente_id = currentPedidoData.pedido.cliente_id;
                const res = await fetchApi(`/api/lab/pedidos/${currentPedidoId}/chips`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cliente_id, iccid, linha, operadora, plano, status: 'Ativo' })
                });
                if (res.ok) {
                    showToast('Chip adicionado', 'success');
                    ['chipIccid', 'chipLinha', 'chipOperadora', 'chipPlano'].forEach(id => document.getElementById(id).value = '');
                    await loadChips();
                }
            } catch (e) { showToast('Erro ao adicionar chip', 'error'); }
        }

        async function toggleChipStatus(id, newStatus) {
            try {
                const res = await fetchApi(`/api/lab/chips/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (res.ok) { showToast(`Chip marcado como ${newStatus}`, 'success'); await loadChips(); }
            } catch (e) { showToast('Erro', 'error'); }
        }

        async function removeChip(id) {
            if (!confirm('Remover chip do pedido?')) return;
            try {
                const res = await fetchApi(`/api/lab/chips/${id}`, { method: 'DELETE' });
                if (res.ok) { showToast('Chip removido', 'success'); await loadChips(); }
            } catch (e) { showToast('Erro', 'error'); }
        }

        // --- Checklists & Gating ---
        async function toggleChecklist(chkId, isChecked) {
            await fetchApi(`/api/pedidos/checklists/${chkId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ concluido: isChecked })
            });
            // Update local memory to reflect immediately for gating
            const fase = currentPedidoData.pedido.status_atual;
            const chks = currentPedidoData.checklists[fase];
            if (chks) {
                const c = chks.find(x => x.id === chkId);
                if (c) c.concluido = isChecked;
            }
            updateGatingButton();
        }

        function updateGatingButton() {
            const pedido = currentPedidoData.pedido;
            const btn = document.getElementById('btnAvancarFase');
            const msg = document.getElementById('gatingMessage');

            if (pedido.status_atual === 'concluido') {
                btn.style.display = 'none';
                msg.textContent = 'Processo totalmente conclu√≠do. ‚úÖ';
                return;
            }

            btn.style.display = 'block';

            const faseAtual = pedido.status_atual;
            const chks = currentPedidoData.checklists[faseAtual] || [];

            const total = chks.length;
            const concluidos = chks.filter(c => c.concluido).length;

            if (total > 0 && concluidos < total) {
                btn.disabled = true;
                msg.textContent = `Trava ativa: Conclua ${concluidos}/${total} do checklist para liberar o avan√ßo.`;
                msg.style.color = '#b06000'; // warning color
            } else {
                btn.disabled = false;
                msg.textContent = `Checklist 100% conclu√≠do! Pronto para avan√ßar.`;
                msg.style.color = '#137333'; // success color
            }
        }

        async function avancarFase() {
            const btn = document.getElementById('btnAvancarFase');
            btn.disabled = true;
            btn.textContent = 'Avan√ßando...';

            const res = await fetchApi(`/api/pedidos/${currentPedidoId}/avancar`, {
                method: 'POST'
            });

            if (res.ok) {
                showToast('Fase avan√ßada com sucesso!', 'success');
                await refreshPedidoData();
            } else {
                const err = await res.json();
                showToast(err.error || 'Erro ao avan√ßar fase', 'error');
                updateGatingButton(); // reset button
            }
        }

        // --- Consultor Externo: Assinatura e O.S. ---
        let signaturePad = null;
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePadCanvas');
            if (canvas && !signaturePad) {
                // Adjust canvas resolution
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgba(255, 255, 255, 1)',
                    penColor: 'rgb(0, 0, 0)'
                });
            }
        }

        function clearSignature() {
            if (signaturePad) signaturePad.clear();
        }

        async function assinarEGerarOS() {
            if (!currentPedidoData || !currentPedidoData.pedido) return;

            const recebedor = document.getElementById('recebedorNome').value.trim();
            if (!recebedor) {
                showToast('Por favor, informe o nome do recebedor.', 'warning');
                return;
            }

            if (!signaturePad || signaturePad.isEmpty()) {
                showToast('A assinatura √© obrigat√≥ria.', 'warning');
                return;
            }

            const btn = document.getElementById('btnAssinarOS');
            btn.disabled = true;
            btn.innerHTML = 'Gerando O.S. e Salvando...';

            try {
                // Calculate Pro-Rata if valor_acordado is present
                const valAcord = document.getElementById('finValorAcordado').value || currentPedidoData.pedido.valor_acordado || 0;

                // Call backend to close the OS, save date
                const res = await fetchApi(`/api/pedidos/${currentPedidoId}/assinar-concluir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor_acordado: valAcord })
                });

                if (!res.ok) throw new Error('Falha ao concluir no banco de dados.');

                // --- Generate PDF ---
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const ped = currentPedidoData.pedido;
                const equips = currentPedidoData.equipamentos || [];
                const pecas = currentPedidoData.pecas || [];

                // Header
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("ORDEM DE SERVI√áO / TERMO DE ENTREGA", 105, 20, { align: "center" });
                doc.setFontSize(12);
                doc.text(`Pedido #${ped.id}`, 105, 28, { align: "center" });

                // Client Info
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.text(`Cliente:`, 14, 45);
                doc.setFont("helvetica", "bold");
                doc.text(`${ped.cliente_nome}`, 35, 45);

                const dataHoje = new Date().toLocaleDateString('pt-BR');
                doc.setFont("helvetica", "normal");
                doc.text(`Data de Entrega: ${dataHoje}`, 14, 52);

                // Equipment List
                let finalY = 65;
                if (equips.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("1. Equipamentos Entregues", 14, finalY);

                    const eqData = equips.map(eq => [eq.serial_number, eq.modelo, eq.acessorios]);
                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['N¬∫ S√©rie', 'Modelo', 'Acess√≥rios']],
                        body: eqData,
                        theme: 'striped',
                        headStyles: { fillColor: [52, 168, 83] } // Green
                    });
                    finalY = doc.lastAutoTable.finalY + 15;
                }

                // Parts/Services List
                if (pecas.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("2. Pe√ßas e Servi√ßos Aplicados (Laborat√≥rio)", 14, finalY);

                    const pecasData = pecas.map(p => [
                        p.componente,
                        p.modelo_equipamento || '-',
                        p.quantidade.toString()
                    ]);
                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Componente', 'Modelo', 'Qtd']],
                        body: pecasData,
                        theme: 'striped',
                        headStyles: { fillColor: [52, 168, 83] }
                    });
                    finalY = doc.lastAutoTable.finalY + 15;
                }

                // Checks/Warning
                doc.setFontSize(10);
                doc.setFont("helvetica", "italic");
                doc.text("Declaro ter recebido os equipamentos descritos acima em perfeitas condi√ß√µes de uso e funcionamento.", 14, finalY);
                finalY += 25;

                // Signature Image
                const signatureDataUrl = signaturePad.toDataURL("image/png");
                doc.addImage(signatureDataUrl, "PNG", 50, finalY, 110, 30);
                finalY += 30;

                // Signature Line
                doc.setLineWidth(0.5);
                doc.line(50, finalY, 160, finalY);
                finalY += 8;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.text(recebedor, 105, finalY, { align: "center" });

                doc.save(`OS_Entrega_${ped.id}_${ped.cliente_nome.replace(/\s+/g, '_')}.pdf`);

                showToast('O.S. Gerada e Pedido Conclu√≠do!', 'success');

                closePedidoPanel(); // Will refresh list
            } catch (e) {
                console.error(e);
                showToast('Erro ao gerar O.S.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚úçÔ∏è Assinar e Finalizar Entrega (Gerar O.S.)';
            }
        }

        // --- PDF Generation M√≥dulo Comercial ---
        async function gerarContratoPDF() {
            if (!currentPedidoData || !currentPedidoData.pedido) return;

            const btn = document.getElementById('btnGerarPDF');
            btn.disabled = true;
            btn.innerHTML = 'Gerando...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const ped = currentPedidoData.pedido;
                const sols = currentPedidoData.solicitacoes || [];

                // Header
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("CONTRATO DE LOCA√á√ÉO E MANUTEN√á√ÉO", 105, 20, { align: "center" });

                doc.setFontSize(12);
                doc.text(`Proposta/Pedido #${ped.id}`, 105, 28, { align: "center" });

                // Client Data
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.text("Cliente / Contratante:", 14, 45);
                doc.setFont("helvetica", "bold");
                doc.text(ped.cliente_nome || 'N/A', 55, 45);

                if (ped.plano_safe_ativo) {
                    doc.setFont("helvetica", "normal");
                    doc.text("Plano Safe Ativo:", 14, 52);
                    doc.setTextColor(0, 150, 0);
                    doc.text(ped.plano_safe_ativo === 'Sim' ? 'SIM (Isento de cobran√ßa de pe√ßas)' : 'N√ÉO', 50, 52);
                    doc.setTextColor(0, 0, 0);
                }

                // Radios Requested
                let finalY = 65;
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("1. Equipamentos Solicitados", 14, finalY);

                if (sols.length > 0) {
                    const solData = sols.map(s => [s.modelo, s.quantidade]);
                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Modelo do Equipamento', 'Quantidade Solicitada']],
                        body: solData,
                        theme: 'striped',
                        headStyles: { fillColor: [52, 168, 83] }
                    });
                    finalY = doc.lastAutoTable.finalY + 15;
                } else {
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    finalY += 8;
                    doc.text("Nenhum equipamento listado no pedido.", 14, finalY);
                    finalY += 15;
                }

                // Indenization Table mapped dynamically to models
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("2. Tabela de Pre√ßos Indenizat√≥rios", 14, finalY);

                // Fetch precos
                const resPrecos = await fetchApi('/api/precos');
                const allPrecos = await resPrecos.json();

                // Filter matching precos to the requested models
                let filteredPrecos = allPrecos;
                if (sols.length > 0) {
                    const modelosReq = sols.map(s => s.modelo.toLowerCase());
                    filteredPrecos = allPrecos.filter(p =>
                        modelosReq.includes(p.modelo_equipamento.toLowerCase()) ||
                        p.modelo_equipamento.toLowerCase() === 'geral'
                    );
                }

                if (filteredPrecos.length > 0) {
                    const precosData = filteredPrecos.map(p => [
                        p.componente,
                        p.modelo_equipamento,
                        `R$ ${p.valor_base.toFixed(2)}`,
                        `R$ ${p.valor_mao_de_obra.toFixed(2)}`
                    ]);

                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Componente / Pe√ßa', 'Modelo', 'Valor da Pe√ßa', 'M√£o de Obra']],
                        body: precosData,
                        theme: 'grid',
                        headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] },
                        styles: { fontSize: 9 }
                    });
                    finalY = doc.lastAutoTable.finalY + 15;
                } else {
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    finalY += 8;
                    doc.text("Nenhuma tabela referenciada para estes modelos.", 14, finalY);
                    finalY += 15;
                }

                // T&C
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                const date = new Date().toLocaleDateString('pt-BR');
                doc.text(`Documento gerado eletronicamente em ${date}. Validade da proposta: 15 dias.`, 14, finalY);

                // Save PDF
                doc.save(`Contrato_Pedido_${ped.id}_${ped.cliente_nome.replace(/\s+/g, '_')}.pdf`);
            } catch (e) {
                console.error('Erro ao gerar PDF', e);
                alert('Erro ao gerar PDF. O console pode conter mais detalhes.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìÑ Gerar Contrato PDF';
            }
        }

        // Init
        loadPrecosIndenizatorios();
        loadPedidos();


        // Escape to close panel
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && currentPedidoId) closePedidoPanel();
        });
    </script>
</body>

</html>